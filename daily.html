<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0f172a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Daily Reports">
  <title>Daily Reports - Comet Builders</title>
  <link rel="apple-touch-icon" sizes="180x180" href="assets/comet_builders_180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="assets/comet_builders_192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="assets/comet_builders_512x512.png">
  <link rel="icon" type="image/svg+xml" href="assets/comet_builders_logo.svg">
  <meta name="description" content="Professional construction daily report system with auto-save and photo compression." />
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    :root{
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --primary-light: #dbeafe;
      --accent: #fbbf24;
      --dark: #0f172a;
      --dark-light: #1e293b;
      --bg: #f8fafc;
      --card: #ffffff;
      --border: #e2e8f0;
      --border-dark: #cbd5e1;
      --text: #0f172a;
      --text-muted: #64748b;
      --success: #10b981;
      --warn: #f59e0b;
      --danger: #ef4444;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
      --shadow-lg: 0 10px 40px rgba(0,0,0,0.12);
    }
    
    *{ box-sizing: border-box; margin: 0; padding: 0; }
    
    html{
      -webkit-overflow-scrolling: touch;
      -webkit-text-size-adjust: 100%;
      scroll-behavior: smooth;
    }
    
    body{
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      -webkit-tap-highlight-color: transparent;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }
    
    a{ color: var(--primary); text-decoration: none; }

    /* Header */
    header{
      background: linear-gradient(135deg, var(--dark) 0%, var(--dark-light) 100%);
      color: white;
      padding: 1rem;
      box-shadow: var(--shadow-lg);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-content{ max-width: 1200px; margin: 0 auto; }
    .brand{ display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem; }
    .logo-container{ width: 48px; height: 48px; flex-shrink: 0; }
    .logo-container svg{ width: 100%; height: 100%; filter: drop-shadow(0 2px 8px rgba(0,0,0,0.3)); }
    .brand-text h1{ font-size: 1.125rem; font-weight: 800; letter-spacing: 0.5px; margin: 0; line-height: 1.2; }
    .brand-text .subtitle{ font-size: 0.8125rem; opacity: 0.9; font-weight: 500; color: var(--accent); }

    /* Action Bar */
    .actions{ display: flex; gap: 0.5rem; align-items: center; }
    .save-status{
      display: flex; align-items: center; justify-content: center; gap: 6px;
      padding: 0.625rem 0.875rem; border-radius: 10px; font-size: 0.8125rem; font-weight: 600;
      background: rgba(255,255,255,0.15); color: white; transition: all 0.3s ease;
      min-height: 40px; border: 1px solid rgba(255,255,255,0.2); flex: 1 1 auto; min-width: 0;
    }
    .save-status.saving{ background: rgba(251, 191, 36, 0.3); border-color: rgba(251, 191, 36, 0.5); }
    .save-status.saved{ background: rgba(16, 185, 129, 0.3); border-color: rgba(16, 185, 129, 0.5); }
    .save-status.unsaved{ background: rgba(239, 68, 68, 0.2); border-color: rgba(239, 68, 68, 0.4); }
    .save-status .dot{ width: 6px; height: 6px; border-radius: 50%; background: currentColor; animation: pulse 2s infinite; }
    @keyframes pulse{ 0%, 100%{ opacity: 1; } 50%{ opacity: 0.5; } }

    /* Dropdown */
    .dropdown{ position: relative; display: inline-block; }
    .dropdown-toggle{ min-width: auto; white-space: nowrap; padding: 0.625rem 0.875rem; }
    .dropdown-menu{
      display: none; position: absolute; top: calc(100% + 0.5rem); right: 0;
      background: var(--card); border: 1px solid var(--border); border-radius: 12px;
      box-shadow: var(--shadow-lg); min-width: 180px; z-index: 1000; overflow: hidden;
    }
    .dropdown-menu.show{ display: block; animation: dropdownSlide 0.2s ease; }
    @keyframes dropdownSlide{ from{ opacity: 0; transform: translateY(-10px); } to{ opacity: 1; transform: translateY(0); } }
    .dropdown-menu button, .dropdown-menu label{
      display: flex; align-items: center; gap: 0.75rem; width: 100%;
      padding: 0.875rem 1.25rem; background: transparent; color: var(--text);
      border: none; border-radius: 0; text-align: left; font-size: 0.9375rem;
      transition: background 0.2s ease; cursor: pointer; min-height: auto; font-weight: 500;
    }
    .dropdown-menu button:hover, .dropdown-menu label:hover{ background: var(--bg); transform: none; }
    .dropdown-menu button:not(:last-child), .dropdown-menu label:not(:last-child){ border-bottom: 1px solid var(--border); }
    .dropdown-menu .success{ color: var(--success); }
    .dropdown-menu .success:hover{ background: rgba(16, 185, 129, 0.05); }

    /* Buttons */
    button, .btn{
      appearance: none; -webkit-appearance: none; border: none;
      background: rgba(255,255,255,0.15); backdrop-filter: blur(10px);
      color: white; padding: 0.625rem 0.875rem; border-radius: 10px;
      font-weight: 600; font-size: 0.875rem; cursor: pointer;
      transition: all 0.2s ease; -webkit-tap-highlight-color: transparent;
      touch-action: manipulation; border: 1px solid rgba(255,255,255,0.2);
      text-decoration: none; display: flex; align-items: center; justify-content: center;
      gap: 0.5rem; min-height: 40px; user-select: none; -webkit-user-select: none;
    }
    button:hover, .btn:hover{ background: rgba(255,255,255,0.25); transform: translateY(-1px); }
    button:active, .btn:active{ transform: translateY(0); }
    .btn.primary{ background: var(--accent); color: var(--dark); border-color: var(--accent); }
    .btn.primary:hover{ background: #f59e0b; }
    .btn.success{ background: rgba(16, 185, 129, 0.2); border-color: rgba(16, 185, 129, 0.4); }
    .btn.success:hover{ background: rgba(16, 185, 129, 0.3); }
    .btn.warn{ background: rgba(245, 158, 11, 0.2); border-color: rgba(245, 158, 11, 0.4); }
    .btn.warn:hover{ background: rgba(245, 158, 11, 0.3); }
    .btn.small{ padding: 0.5rem 0.875rem; font-size: 0.8125rem; min-height: 40px; }

    /* Container */
    .wrap{ max-width: 1200px; margin: 0 auto; padding: 1.5rem 1rem 3rem; }

    /* Grid & Cards */
    .grid{ display: grid; gap: 1.5rem; }
    .card{
      background: var(--card); border: 1px solid var(--border); border-radius: 16px;
      padding: 1.5rem; box-shadow: var(--shadow); transition: box-shadow 0.3s ease;
    }
    .card:hover{ box-shadow: var(--shadow-lg); }
    .card h2{
      font-size: 1.125rem; margin: 0 0 1.25rem 0; color: var(--text);
      font-weight: 700; display: flex; align-items: center; gap: 0.5rem;
    }
    .card h2::before{
      content: ''; width: 4px; height: 1.5rem;
      background: linear-gradient(180deg, var(--primary), var(--primary-hover)); border-radius: 2px;
    }

    /* Form Elements */
    .row{ display: grid; grid-template-columns: repeat(12, 1fr); gap: 1rem; margin-bottom: 1rem; }
    label{
      display: block; font-size: 0.875rem; color: var(--text-muted);
      font-weight: 600; margin-bottom: 0.5rem; letter-spacing: 0.01em;
    }
    input, select, textarea{
      width: 100%; padding: 0.875rem 1rem; border-radius: 10px;
      border: 2px solid var(--border); background: var(--card); color: var(--text);
      font-size: 1rem; transition: all 0.2s ease; font-family: inherit;
      -webkit-appearance: none; appearance: none;
    }
    input:focus, select:focus, textarea:focus{ outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
    textarea{ min-height: 100px; resize: vertical; line-height: 1.5; overflow: hidden; }

    /* Tables */
    .table-wrap{
      overflow-x: auto; margin-top: 1rem; border-radius: 12px;
      border: 1px solid var(--border); -webkit-overflow-scrolling: touch;
    }
    table{ width: 100%; border-collapse: collapse; background: var(--card); min-width: 800px; }
    th, td{ padding: 0.875rem 0.75rem; text-align: left; vertical-align: top; white-space: nowrap; }
    th{
      background: #f1f5f9; color: var(--text); font-weight: 700; font-size: 0.8125rem;
      text-transform: uppercase; letter-spacing: 0.03em; border-bottom: 2px solid var(--border-dark);
      position: sticky; top: 0; z-index: 2;
    }
    td{ border-bottom: 1px solid var(--border); }
    tr:last-child td{ border-bottom: none; }
    tr:hover{ background: #f8fafc; }
    td input, td textarea, td select{
      border: 1px solid var(--border); padding: 0.75rem 0.875rem;
      font-size: 0.9375rem; background: var(--card); min-height: 42px;
    }
    td input:focus, td textarea:focus, td select:focus{ background: var(--primary-light); box-shadow: none; }
    td textarea.grow{
      min-height: 42px; min-width: 200px; resize: vertical;
      white-space: normal; line-height: 1.5; overflow: hidden;
    }
    td button[data-remove]{
      min-height: 38px; padding: 0.5rem 0.875rem;
      background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3); color: var(--danger);
    }
    td button[data-remove]:hover{ background: rgba(239, 68, 68, 0.2); }

    /* Tools */
    .tools{
      display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem;
      padding-bottom: 1rem; border-bottom: 1px solid var(--border); align-items: center;
    }
    .muted{ color: var(--text-muted); font-size: 0.8125rem; }

    /* Gallery */
    .gallery{
      display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem; margin-top: 1rem;
    }
    .photo-item{
      position: relative; border-radius: 12px; overflow: hidden;
      background: #f8fafc; border: 1px solid var(--border);
    }
    .photo-item .photo-img-wrap{
      aspect-ratio: 4/3; cursor: pointer; overflow: hidden;
    }
    .photo-item img{
      width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease;
    }
    .photo-item:hover img{ transform: scale(1.05); }
    .photo-item .remove-photo{
      position: absolute; top: 8px; right: 8px; background: rgba(239, 68, 68, 0.95);
      color: var(--card); border: none; width: 32px; height: 32px; border-radius: 50%;
      cursor: pointer; font-size: 18px; display: flex; align-items: center;
      justify-content: center; opacity: 0; transition: opacity 0.2s ease; z-index: 10;
    }
    .photo-item:hover .remove-photo{ opacity: 1; }
    .photo-meta{
      padding: 0.5rem 0.625rem; border-top: 1px solid var(--border);
      background: #fafbfc;
    }
    .photo-meta select, .photo-meta input{
      width: 100%; padding: 0.4rem 0.5rem; font-size: 0.8125rem;
      border: 1px solid var(--border); border-radius: 6px; margin-bottom: 0.35rem;
      min-height: auto;
    }
    .photo-meta select:last-child, .photo-meta input:last-child{ margin-bottom: 0; }

    /* Work Summary (auto-generated) */
    .work-summary{
      background: linear-gradient(135deg, #f0f9ff, #f8fafc);
      border: 2px solid var(--primary-light);
      border-radius: 12px; padding: 1.25rem; min-height: 80px;
    }
    .work-summary-empty{
      color: var(--text-muted); font-style: italic; font-size: 0.9375rem;
    }
    .work-summary h3{
      font-size: 0.9375rem; font-weight: 700; color: var(--primary);
      margin: 0 0 0.375rem 0;
    }
    .work-summary p{
      margin: 0 0 0.25rem 0; font-size: 0.9375rem; line-height: 1.5; color: var(--text);
    }
    .work-summary .building-group{ margin-bottom: 0.75rem; }
    .work-summary .building-group:last-child{ margin-bottom: 0; }
    .auto-badge{
      display: inline-flex; align-items: center; gap: 4px;
      background: var(--primary-light); color: var(--primary);
      font-size: 0.6875rem; font-weight: 700; padding: 0.2rem 0.5rem;
      border-radius: 6px; text-transform: uppercase; letter-spacing: 0.04em;
    }

    /* Weather fetch button */
    .weather-fetch-btn{
      background: var(--primary) !important; color: white !important;
      border-color: var(--primary) !important; white-space: nowrap;
    }
    .weather-fetch-btn:hover{ background: var(--primary-hover) !important; }
    .weather-fetch-btn.loading{
      opacity: 0.7; pointer-events: none;
    }

    /* Template buttons */
    .template-btn{
      background: rgba(139, 92, 246, 0.15) !important;
      border-color: rgba(139, 92, 246, 0.4) !important;
      color: #7c3aed !important;
    }
    .template-btn:hover{
      background: rgba(139, 92, 246, 0.25) !important;
    }

    /* Modal */
    .modal{
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.9); z-index: 2000;
      align-items: center; justify-content: center; padding: 20px;
    }
    .modal.active{ display: flex; }
    .modal img{ max-width: 100%; max-height: 90vh; object-fit: contain; border-radius: 8px; }
    .modal-close{
      position: absolute; top: 20px; right: 20px; background: var(--card);
      color: var(--text); border: none; width: 48px; height: 48px; border-radius: 50%;
      cursor: pointer; font-size: 24px; display: flex; align-items: center; justify-content: center;
    }

    /* KPI */
    .kpi{ display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem; }
    .kpi .box{
      flex: 1 1 160px; background: linear-gradient(135deg, #f8fafc, var(--card));
      border: 1px solid var(--border); border-radius: 12px; padding: 1rem;
      box-shadow: var(--shadow); min-height: 90px;
    }
    .kpi .box label{
      font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem;
      text-transform: uppercase; letter-spacing: 0.05em;
    }
    .box b{ font-size: 1.75rem; color: var(--primary); font-weight: 700; display: block; }

    /* History */
    .history-item{
      display: flex; gap: 1rem; align-items: center; margin: 0.75rem 0;
      padding: 1rem; border: 1px solid var(--border); border-radius: 12px;
      background: var(--card); transition: all 0.2s ease; flex-wrap: wrap;
      cursor: pointer; user-select: none;
    }
    .history-item:hover{ box-shadow: var(--shadow); border-color: var(--primary-hover); }
    .history-item .info{ flex: 1 1 200px; }
    .history-item .title{
      font-weight: 600; color: var(--text); margin-bottom: 0.25rem;
      display: flex; align-items: center; gap: 0.5rem;
    }
    .history-item .title::before{
      content: '‚ñ∂'; font-size: 0.75rem; color: var(--primary); transition: transform 0.2s ease;
    }
    .history-item.expanded .title::before{ transform: rotate(90deg); }
    .history-item .meta{ font-size: 0.75rem; color: var(--text-muted); }
    .history-item .actions-group{
      display: none; gap: 0.5rem; flex-wrap: wrap; width: 100%;
      margin-top: 0.5rem; padding-top: 0.75rem; border-top: 1px solid var(--border);
    }
    .history-item.expanded .actions-group{ display: flex; }
    .history-item .btn{ background: var(--card); color: var(--text); border: 1px solid var(--border-dark); }
    .history-item .btn:hover{ background: #f8fafc; }
    .history-item .btn.danger{ color: var(--danger); border-color: rgba(239, 68, 68, 0.3); }

    /* Toast */
    .toast{
      position: fixed; bottom: 24px; right: 24px; padding: 1rem 1.25rem;
      background: var(--dark); color: var(--card); border-radius: 12px;
      box-shadow: var(--shadow-lg); z-index: 3000; animation: slideUp 0.3s ease;
      display: flex; align-items: center; gap: 0.625rem; max-width: 400px;
      font-weight: 500; font-size: 0.875rem;
    }
    .toast.success{ background: var(--success); }
    .toast.error{ background: #dc2626; }
    .toast.warning{ background: var(--warn); }
    @keyframes slideUp{ from{ transform: translateY(100px); opacity: 0; } to{ transform: translateY(0); opacity: 1; } }

    /* Offline */
    .offline-banner{
      display: none; position: fixed; bottom: 0; left: 0; right: 0;
      background: var(--warn); color: var(--card); padding: 1rem;
      text-align: center; font-weight: 700; z-index: 1500; font-size: 0.875rem;
    }
    .offline-banner.active{ display: block; }

    /* Mobile */
    @media(max-width: 768px){
      header{ padding: 0.875rem; }
      .logo-container{ width: 42px; height: 42px; }
      .brand{ gap: 0.625rem; margin-bottom: 0.625rem; }
      .brand-text h1{ font-size: 1rem; }
      .brand-text .subtitle{ font-size: 0.75rem; }
      .actions{ gap: 0.5rem; }
      .dropdown-toggle{ padding: 0.625rem 0.75rem; font-size: 0.8125rem; }
      .save-status{ padding: 0.625rem 0.875rem; font-size: 0.8125rem; }
      .wrap{ padding: 1rem 0.75rem 2rem; }
      .card{ padding: 1.25rem; border-radius: 12px; }
      .row{ grid-template-columns: 1fr; gap: 0.875rem; }
      .row > div{ grid-column: span 1 !important; }
      .table-wrap{ border-radius: 10px; margin-left: -0.75rem; margin-right: -0.75rem; border-left: none; border-right: none; }
      table{ min-width: 1000px; font-size: 0.9375rem; }
      th, td{ padding: 0.75rem 0.625rem; font-size: 0.875rem; }
      td input, td textarea, td select{ font-size: 1rem; padding: 0.75rem 0.875rem; }
      td textarea.grow{ min-width: 280px; }
      .gallery{ grid-template-columns: repeat(2, 1fr); gap: 0.875rem; }
      .kpi{ gap: 0.875rem; }
      .kpi .box{ padding: 0.875rem; flex: 1 1 140px; min-height: 85px; }
      .box b{ font-size: 1.625rem; }
      .toast{ bottom: 1rem; right: 1rem; left: 1rem; max-width: none; }
      .history-item{ padding: 0.875rem; }
      .history-item .title{ font-size: 0.9375rem; }
      .history-item .actions-group{ width: 100%; gap: 0.75rem; }
      .history-item .btn{
        flex: 1 1 auto; min-width: 0; min-height: 44px !important;
        padding: 0.75rem 1rem !important; font-size: 0.9375rem !important;
        touch-action: manipulation; -webkit-tap-highlight-color: rgba(37, 99, 235, 0.2);
        user-select: none; -webkit-user-select: none; -webkit-touch-callout: none;
        position: relative; z-index: 10;
      }
    }
    @media(max-width: 480px){
      .btn{ font-size: 0.8125rem; padding: 0.625rem 0.75rem; }
    }

    /* ===== PRINT STYLES ===== */
    @media print {
      @page { size: letter portrait; margin: 0.35in; }
      body {
        background: white !important; color: #000 !important;
        -webkit-print-color-adjust: exact; print-color-adjust: exact;
        padding: 0 !important; font-size: 8pt !important; line-height: 1.3 !important;
      }
      header {
        display: block !important; position: static !important; box-shadow: none !important;
        background: #1e293b !important; padding: 0.4rem 0.5rem !important; margin-bottom: 0.4rem !important;
        -webkit-print-color-adjust: exact; print-color-adjust: exact;
      }
      .header-content { max-width: 100% !important; }
      .brand { display: flex !important; align-items: center !important; gap: 0.5rem !important; margin-bottom: 0 !important; }
      .logo-container { width: 40px !important; height: 40px !important; flex-shrink: 0 !important; }
      .logo-container svg { width: 100% !important; height: 100% !important; }
      .brand-text h1 { font-size: 12pt !important; color: white !important; margin: 0 !important; }
      .brand-text .subtitle { font-size: 9pt !important; color: #fbbf24 !important; }
      .actions, .dropdown, .save-status, .btn, .tools, .offline-banner, .modal, .toast { display: none !important; }
      #historyCard, #history, .history-item { display: none !important; }
      .wrap { padding: 0; max-width: 100%; }
      .grid { gap: 0.4rem !important; }
      .card {
        break-inside: avoid; background: white !important; border: 1.5pt solid #000 !important;
        box-shadow: none !important; page-break-inside: avoid; margin-bottom: 0.35rem;
        padding: 0.4rem !important; border-radius: 0 !important;
      }
      .card h2 { page-break-after: avoid; font-size: 9pt !important; font-weight: bold !important; margin-bottom: 0.25rem !important; color: #000 !important; }
      .card h2::before { background: #000 !important; width: 3px !important; height: 0.9rem !important; }
      .row {
        display: flex !important; flex-wrap: wrap !important; gap: 0.3rem !important;
        page-break-inside: avoid; margin-bottom: 0.25rem !important;
      }
      .row > div { flex: 1 1 auto !important; min-width: 120px !important; overflow: visible !important; }
      input, select {
        background: white !important; color: #000 !important; border: 1pt solid #555 !important;
        -webkit-text-fill-color: #000 !important; font-size: 8pt !important;
        padding: 0.15rem 0.2rem !important; overflow: visible !important;
        text-overflow: unset !important; white-space: nowrap !important;
        height: auto !important; min-height: 1.2em !important; max-height: none !important;
        border-radius: 0 !important; width: 100% !important; box-sizing: border-box !important;
      }
      textarea {
        background: white !important; color: #000 !important; border: 1pt solid #555 !important;
        -webkit-text-fill-color: #000 !important; font-size: 8pt !important;
        padding: 0.15rem 0.2rem !important; min-height: auto !important; height: auto !important;
        overflow: visible !important; resize: none !important; white-space: pre-wrap !important;
        word-wrap: break-word !important; border-radius: 0 !important; width: 100% !important;
        box-sizing: border-box !important;
      }
      label { font-size: 6pt !important; font-weight: bold !important; margin-bottom: 0.05rem !important; color: #000 !important; text-transform: uppercase !important; }
      .table-wrap { overflow: visible !important; border: none !important; margin: 0.2rem 0 !important; border-radius: 0 !important; }
      table { width: 100% !important; min-width: 0 !important; font-size: 7pt !important; page-break-inside: auto; table-layout: auto !important; border-collapse: collapse !important; }
      thead { display: table-header-group; }
      tbody { display: table-row-group; }
      tr { page-break-inside: avoid; page-break-after: auto; }
      th, td { border: 1pt solid #000 !important; color: #000 !important; padding: 0.1rem 0.15rem !important; font-size: 7pt !important; white-space: nowrap !important; overflow: visible !important; vertical-align: top !important; }
      th { background: #ddd !important; color: #000 !important; font-weight: bold !important; font-size: 6pt !important; text-transform: uppercase !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      td input, td select { font-size: 7pt !important; padding: 0.05rem !important; width: 100% !important; border: none !important; background: transparent !important; overflow: visible !important; white-space: nowrap !important; height: auto !important; min-height: auto !important; max-height: none !important; }
      td textarea { font-size: 7pt !important; padding: 0.05rem !important; width: 100% !important; border: none !important; background: transparent !important; overflow: visible !important; white-space: pre-wrap !important; word-wrap: break-word !important; height: auto !important; min-height: auto !important; max-height: none !important; }
      td textarea.grow { min-width: 0 !important; width: 100% !important; height: auto !important; overflow: visible !important; }
      td button { display: none !important; }
      th:last-child, td:last-child { display: none !important; }
      .kpi { display: flex !important; gap: 0.2rem !important; page-break-inside: avoid; margin-top: 0.25rem !important; }
      .kpi .box { background: white !important; color: #000 !important; border: 1.5pt solid #000 !important; flex: 1; padding: 0.2rem !important; min-height: auto !important; border-radius: 0 !important; }
      .kpi .box label { color: #000 !important; font-size: 5pt !important; }
      .kpi .box b { color: #000 !important; font-size: 11pt !important; }
      .gallery { grid-template-columns: repeat(4, 1fr) !important; gap: 0.2rem !important; page-break-inside: avoid; }
      .photo-item { break-inside: avoid; border-radius: 0 !important; }
      .photo-item .remove-photo { display: none !important; }
      .photo-item img { max-height: 80px !important; }
      .photo-meta { padding: 0.15rem !important; }
      .photo-meta select, .photo-meta input { font-size: 6pt !important; padding: 0.1rem !important; border: none !important; background: transparent !important; }
      .work-summary { border: 1.5pt solid #000 !important; background: white !important; padding: 0.3rem !important; border-radius: 0 !important; }
      .work-summary h3 { font-size: 8pt !important; color: #000 !important; }
      .work-summary p { font-size: 7pt !important; color: #000 !important; }
      .auto-badge { font-size: 5pt !important; background: #eee !important; color: #000 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .card:nth-last-child(1) { display: none !important; }
    }
  </style>
</head>
<body>

  <script>
    (function(){
      var APP_VERSION = '2025-02-17-UPGRADE-v1';
      try {
        var stored = localStorage.getItem('app_version');
        if (stored !== APP_VERSION) {
          if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(regs){
              regs.forEach(function(r){ r.unregister(); });
              if (window.caches && caches.keys) {
                caches.keys().then(function(keys){
                  keys.forEach(function(k){ caches.delete(k); });
                  localStorage.setItem('app_version', APP_VERSION);
                  location.reload();
                });
              } else {
                localStorage.setItem('app_version', APP_VERSION);
                location.reload();
              }
            });
          } else {
            localStorage.setItem('app_version', APP_VERSION);
          }
        }
      } catch (e) {}
    })();
  </script>

  <div class="offline-banner" id="offlineBanner">
    üì° You're offline. Changes are saved locally and will sync when reconnected.
  </div>

  <div class="modal" id="imageModal" onclick="if(event.target.id==='imageModal')closeImageModal()">
    <button class="modal-close" onclick="closeImageModal()">√ó</button>
    <img id="modalImg" src="" alt="Preview">
  </div>

  <header>
    <div class="header-content">
      <div class="brand">
        <div class="logo-container">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
            <defs>
              <linearGradient id="professionalBg" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" style="stop-color:#1e3a8a;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#0f172a;stop-opacity:1" />
              </linearGradient>
              <linearGradient id="brickGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" style="stop-color:#7c3aed;stop-opacity:0.3" />
                <stop offset="100%" style="stop-color:#6366f1;stop-opacity:0.5" />
              </linearGradient>
              <linearGradient id="sidingGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" style="stop-color:#60a5fa;stop-opacity:0.6" />
                <stop offset="100%" style="stop-color:#3b82f6;stop-opacity:0.7" />
              </linearGradient>
              <linearGradient id="roofGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" style="stop-color:#94a3b8;stop-opacity:0.8" />
                <stop offset="100%" style="stop-color:#64748b;stop-opacity:0.9" />
              </linearGradient>
              <linearGradient id="cometGold" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#fde047;stop-opacity:1" />
                <stop offset="50%" style="stop-color:#fbbf24;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#f59e0b;stop-opacity:1" />
              </linearGradient>
            </defs>
            <rect width="512" height="512" rx="110" fill="url(#professionalBg)"/>
            <path d="M 80 90 L 380 155" stroke="url(#cometGold)" stroke-width="5" fill="none" opacity="0.7" stroke-linecap="round"/>
            <path d="M 90 95 L 375 157" stroke="#fde047" stroke-width="2.5" fill="none" opacity="0.9" stroke-linecap="round"/>
            <circle cx="390" cy="160" r="20" fill="url(#cometGold)"/>
            <circle cx="390" cy="160" r="12" fill="#fde047"/>
            <path d="M 390 160 l 9 5 l 5 9 l -5 -9 l -9 5 l 5 -9 l 9 -5 l -5 9 z" fill="#ffffff" opacity="0.9"/>
            <circle cx="256" cy="280" r="140" fill="#0f172a" stroke="url(#cometGold)" stroke-width="6"/>
            <circle cx="256" cy="280" r="130" fill="#1e293b"/>
            <rect x="130" y="310" width="55" height="50" fill="url(#brickGrad)"/>
            <rect x="135" y="318" width="10" height="12" fill="#dbeafe" opacity="0.9"/>
            <rect x="148" y="318" width="10" height="12" fill="#dbeafe" opacity="0.9"/>
            <rect x="161" y="318" width="10" height="12" fill="#dbeafe" opacity="0.9"/>
            <rect x="135" y="345" width="10" height="12" fill="#dbeafe" opacity="0.9"/>
            <rect x="161" y="345" width="10" height="12" fill="#dbeafe" opacity="0.9"/>
            <rect x="148" y="345" width="10" height="15" fill="#1e3a8a" opacity="0.8"/>
            <rect x="130" y="295" width="55" height="15" fill="url(#sidingGrad)"/>
            <rect x="135" y="298" width="10" height="10" fill="#dbeafe" opacity="0.9"/>
            <rect x="148" y="298" width="10" height="10" fill="#dbeafe" opacity="0.9"/>
            <rect x="161" y="298" width="10" height="10" fill="#dbeafe" opacity="0.9"/>
            <path d="M 127 295 L 157.5 270 L 188 295 Z" fill="url(#roofGrad)"/>
            <rect x="195" y="300" width="65" height="60" fill="url(#brickGrad)"/>
            <rect x="200" y="308" width="11" height="14" fill="#dbeafe"/>
            <rect x="215" y="308" width="11" height="14" fill="#dbeafe"/>
            <rect x="230" y="308" width="11" height="14" fill="#dbeafe"/>
            <rect x="245" y="308" width="11" height="14" fill="#dbeafe"/>
            <rect x="200" y="340" width="11" height="18" fill="#1e3a8a" opacity="0.8"/>
            <rect x="230" y="340" width="11" height="18" fill="#1e3a8a" opacity="0.8"/>
            <rect x="195" y="285" width="65" height="15" fill="url(#sidingGrad)"/>
            <rect x="200" y="288" width="11" height="10" fill="#dbeafe"/>
            <rect x="215" y="288" width="11" height="10" fill="#dbeafe"/>
            <rect x="230" y="288" width="11" height="10" fill="#dbeafe"/>
            <rect x="245" y="288" width="11" height="10" fill="#dbeafe"/>
            <rect x="195" y="270" width="65" height="15" fill="url(#brickGrad)"/>
            <rect x="215" y="273" width="11" height="9" fill="#dbeafe"/>
            <rect x="230" y="273" width="11" height="9" fill="#dbeafe"/>
            <path d="M 193 270 L 227.5 240 L 262 270 Z" fill="url(#roofGrad)"/>
            <rect x="245" y="343" width="12" height="15" fill="#475569" opacity="0.7"/>
            <line x1="245" y1="347" x2="257" y2="347" stroke="#94a3b8" stroke-width="0.5"/>
            <line x1="245" y1="350" x2="257" y2="350" stroke="#94a3b8" stroke-width="0.5"/>
            <line x1="245" y1="353" x2="257" y2="353" stroke="#94a3b8" stroke-width="0.5"/>
            <rect x="270" y="305" width="58" height="55" fill="url(#sidingGrad)"/>
            <rect x="275" y="313" width="10" height="13" fill="#dbeafe" opacity="0.9"/>
            <rect x="289" y="313" width="10" height="13" fill="#dbeafe" opacity="0.9"/>
            <rect x="303" y="313" width="10" height="13" fill="#dbeafe" opacity="0.9"/>
            <rect x="317" y="313" width="10" height="13" fill="#dbeafe" opacity="0.9"/>
            <rect x="275" y="343" width="10" height="16" fill="#1e3a8a" opacity="0.8"/>
            <rect x="303" y="343" width="10" height="16" fill="#1e3a8a" opacity="0.8"/>
            <rect x="270" y="290" width="58" height="15" fill="url(#brickGrad)"/>
            <rect x="275" y="293" width="10" height="10" fill="#dbeafe" opacity="0.9"/>
            <rect x="289" y="293" width="10" height="10" fill="#dbeafe" opacity="0.9"/>
            <rect x="303" y="293" width="10" height="10" fill="#dbeafe" opacity="0.9"/>
            <rect x="317" y="293" width="10" height="10" fill="#dbeafe" opacity="0.9"/>
            <path d="M 267 290 L 299 265 L 331 290 Z" fill="url(#roofGrad)"/>
            <rect x="335" y="312" width="45" height="48" fill="url(#brickGrad)"/>
            <rect x="340" y="320" width="9" height="12" fill="#dbeafe" opacity="0.9"/>
            <rect x="352" y="320" width="9" height="12" fill="#dbeafe" opacity="0.9"/>
            <rect x="364" y="320" width="9" height="12" fill="#dbeafe" opacity="0.9"/>
            <rect x="340" y="345" width="9" height="14" fill="#1e3a8a" opacity="0.8"/>
            <rect x="364" y="345" width="9" height="14" fill="#1e3a8a" opacity="0.8"/>
            <rect x="335" y="300" width="45" height="12" fill="url(#sidingGrad)"/>
            <rect x="340" y="303" width="9" height="8" fill="#dbeafe" opacity="0.9"/>
            <rect x="352" y="303" width="9" height="8" fill="#dbeafe" opacity="0.9"/>
            <rect x="364" y="303" width="9" height="8" fill="#dbeafe" opacity="0.9"/>
            <path d="M 332 300 L 357.5 278 L 383 300 Z" fill="url(#roofGrad)"/>
            <ellipse cx="256" cy="370" rx="125" ry="15" fill="#2D5016" opacity="0.4"/>
            <ellipse cx="125" cy="365" rx="8" ry="10" fill="#2D5016" opacity="0.6"/>
            <ellipse cx="385" cy="368" rx="8" ry="10" fill="#2D5016" opacity="0.6"/>
            <text x="256" y="450" font-family="Arial, sans-serif" font-size="46" font-weight="900" text-anchor="middle" fill="#ffffff" letter-spacing="10">COMET</text>
            <text x="256" y="485" font-family="Arial, sans-serif" font-size="28" font-weight="600" text-anchor="middle" fill="#60a5fa" letter-spacing="8">BUILDERS</text>
          </svg>
        </div>
        <div class="brand-text">
          <h1>Comet Builders LLC</h1>
          <div class="subtitle">Daily Reports</div>
        </div>
      </div>
      <div class="actions">
        <a href="index.html" class="btn">üè†</a>
        <div class="save-status" id="saveStatus">
          <span class="dot"></span>
          <span id="saveText">Ready</span>
        </div>
        <div class="dropdown" id="actionsDropdown">
          <button class="btn dropdown-toggle" id="actionsToggle">‚ö° Actions</button>
          <div class="dropdown-menu" id="actionsMenu">
            <button id="saveBtn" class="success">üíæ Save Report</button>
            <button id="copyPrevBtn">üìã Copy Yesterday</button>
            <button id="newBtn">üÜï New Report</button>
            <button id="exportBtn">üíæ Export JSON</button>
            <button id="exportPdfBtn">üìÑ Export PDF</button>
            <label for="importFile">üì• Import JSON</label>
            <input type="file" id="importFile" accept="application/json" hidden>
            <button id="printBtn" class="success">üñ®Ô∏è Print</button>
            <button id="pdfBtn" class="success">üìÑ Save PDF</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="wrap">
    <section class="grid">

      <!-- Report Meta -->
      <div class="card">
        <h2>Report Information</h2>
        <div class="row">
          <div style="grid-column:span 3">
            <label for="date">Date *</label>
            <input type="date" id="date" required>
          </div>
          <div style="grid-column:span 5">
            <label for="project">Project *</label>
            <select id="project" required>
              <option value="">Select project‚Ä¶</option>
              <option>Comet Sneads Ferry Apartments</option>
              <option>Comet Pittsboro Apartments</option>
              <option>Comet Richlands</option>
              <option>Comet North Raleigh</option>
              <option>Comet Lake Jeanette</option>
              <option value="custom">Custom‚Ä¶</option>
            </select>
          </div>
          <div style="grid-column:span 4">
            <label for="customProject">Custom Project Name</label>
            <input id="customProject" placeholder="Enter if Custom selected" />
          </div>
        </div>
        <div class="row">
          <div style="grid-column:span 3">
            <label for="weather">Weather Summary</label>
            <input id="weather" placeholder="78¬∞F, partly cloudy" />
          </div>
          <div style="grid-column:span 2">
            <label for="tempRange">Temp Range</label>
            <input id="tempRange" placeholder="65‚Äì82¬∞F" />
          </div>
          <div style="grid-column:span 2">
            <label for="precip">Precipitation</label>
            <input id="precip" placeholder="0.0 in" />
          </div>
          <div style="grid-column:span 2">
            <label for="wind">Wind</label>
            <input id="wind" placeholder="5 mph SW" />
          </div>
          <div style="grid-column:span 3; display:flex; align-items:flex-end;">
            <button class="btn small weather-fetch-btn" id="weatherFetchBtn" type="button" style="width:100%">üå§Ô∏è Auto-Fill Weather</button>
          </div>
        </div>
        <div class="kpi">
          <div class="box"><label>Total Crew</label><div><b id="kpiCrew">0</b></div></div>
          <div class="box"><label>Vendors On-Site</label><div><b id="kpiVendors">0</b></div></div>
          <div class="box"><label>Open Issues</label><div><b id="kpiIssues">0</b></div></div>
          <div class="box"><label>Inspections</label><div><b id="kpiInsp">0</b></div></div>
        </div>
      </div>

      <!-- Manpower & Vendors -->
      <div class="card">
        <h2>Manpower & Vendors</h2>
        <div class="tools">
          <button class="btn small" id="addLabor">‚ûï Add Row</button>
          <button class="btn small" id="add5Labor">‚ûï 5 Rows</button>
          <button class="btn small" id="clearLabor">üóëÔ∏è Clear</button>
          <button class="btn small template-btn" id="saveTemplate">üíæ Save Crew Template</button>
          <button class="btn small template-btn" id="loadTemplate">üìÇ Load Template</button>
          <span class="muted">Track all subcontractors and crews on site</span>
        </div>
        <div class="table-wrap">
          <table id="laborTable">
            <thead>
              <tr>
                <th>Company / Trade</th>
                <th>Building/Area</th>
                <th>Supervisor</th>
                <th># Crew</th>
                <th>Time On</th>
                <th>Time Off</th>
                <th>Notes</th>
                <th style="width:60px">‚Äî</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Work Performed (Auto-Generated) -->
      <div class="card">
        <h2>Work Performed Today <span class="auto-badge">‚ö° Auto-Generated</span></h2>
        <p class="muted" style="margin-bottom:0.75rem;">This summary is built automatically from the Manpower table above. Add Building/Area and Notes to each crew row and it updates in real time.</p>
        <div class="work-summary" id="workSummary">
          <div class="work-summary-empty">No labor entries yet. Add crews above and this summary will populate automatically.</div>
        </div>
      </div>

      <!-- Deliveries -->
      <div class="card">
        <h2>Material Deliveries</h2>
        <div class="tools">
          <button class="btn small" id="addDelivery">‚ûï Add Delivery</button>
          <button class="btn small" id="clearDelivery">üóëÔ∏è Clear</button>
        </div>
        <div class="table-wrap">
          <table id="deliveryTable">
            <thead>
              <tr>
                <th>Time</th>
                <th>Vendor</th>
                <th>Material / Qty</th>
                <th>For Area</th>
                <th>Notes</th>
                <th>Received By</th>
                <th style="width:60px">‚Äî</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Inspections -->
      <div class="card">
        <h2>Inspections & Testing</h2>
        <div class="tools">
          <button class="btn small" id="addInsp">‚ûï Add Item</button>
          <button class="btn small" id="clearInsp">üóëÔ∏è Clear</button>
        </div>
        <div class="table-wrap">
          <table id="inspTable">
            <thead>
              <tr>
                <th>Agency / Inspector</th>
                <th>Type</th>
                <th>Building/Area</th>
                <th>Status</th>
                <th>Notes</th>
                <th style="width:60px">‚Äî</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Equipment -->
      <div class="card">
        <h2>Equipment On-Site</h2>
        <div class="tools">
          <button class="btn small" id="addEquip">‚ûï Add Equipment</button>
          <button class="btn small" id="clearEquip">üóëÔ∏è Clear</button>
          <span class="muted">Track all equipment to prevent loss/damage</span>
        </div>
        <div class="table-wrap">
          <table id="equipTable">
            <thead>
              <tr>
                <th>Type/Model</th>
                <th>Owner/Subcontractor</th>
                <th>Qty</th>
                <th>Location</th>
                <th>Condition/Notes</th>
                <th style="width:60px">‚Äî</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Safety -->
      <div class="card">
        <h2>Safety & Incidents</h2>
        <div class="row">
          <div style="grid-column:span 6">
            <label for="safetyObservations">Safety Observations / Toolbox Talks</label>
            <textarea id="safetyObservations" placeholder="PPE compliance checks, toolbox talk topics, safety concerns addressed, near-miss events"></textarea>
          </div>
          <div style="grid-column:span 6">
            <label for="incidents">Incidents / Accidents</label>
            <textarea id="incidents" placeholder="Document any incidents, injuries, or property damage. Write 'N/A' if none occurred."></textarea>
          </div>
        </div>
      </div>

      <!-- Delays -->
      <div class="card">
        <h2>Delays, Constraints & Issues</h2>
        <div class="row">
          <div style="grid-column:span 12">
            <label for="delays">Today's Delays / Constraints / RFI Needs</label>
            <textarea id="delays" placeholder="Pending inspections, utility conflicts, weather delays, material shortages, approvals needed, change order items, etc."></textarea>
          </div>
        </div>
      </div>

      <!-- Photos -->
      <div class="card">
        <h2>Site Photos</h2>
        <div class="tools">
          <label class="btn small" for="photoInput">üì∑ Add Photos</label>
          <input type="file" id="photoInput" accept="image/*" multiple capture="environment" hidden>
          <button class="btn small" id="clearPhotos">üóëÔ∏è Clear All</button>
          <span class="muted">Photos are compressed locally. Tag each with building/area.</span>
        </div>
        <div class="gallery" id="gallery"></div>
      </div>

      <!-- Sign-off -->
      <div class="card">
        <h2>Report Sign-Off</h2>
        <div class="row">
          <div style="grid-column:span 4">
            <label for="preparedBy">Prepared By *</label>
            <input id="preparedBy" placeholder="Your full name" required />
          </div>
          <div style="grid-column:span 4">
            <label for="titleField">Title</label>
            <input id="titleField" placeholder="Superintendent" />
          </div>
          <div style="grid-column:span 4">
            <label for="preparedAt">Time Prepared</label>
            <input id="preparedAt" type="time" />
          </div>
        </div>
      </div>

      <!-- History -->
      <div class="card" id="historyCard">
        <h2>Saved Reports</h2>
        <div class="tools">
          <button class="btn warn small" id="wipeAll">üóëÔ∏è Delete All Drafts</button>
          <span class="muted">Click any report to expand and see actions. Export JSON for backup.</span>
        </div>
        <div id="history"></div>
      </div>
    </section>
  </div>

  <script>
  (function(){
    'use strict';

    function $(s, r){ return (r||document).querySelector(s); }
    function $$(s, r){ return Array.prototype.slice.call((r||document).querySelectorAll(s)); }

    var STORAGE_KEY = 'dailyReportDrafts_v4_upgraded';
    var TEMPLATE_KEY = 'crewTemplates_v1';
    var currentId = null;
    var autoSaveTimer = null;
    var hasUnsavedChanges = false;

    // ===== Project Coordinates for Weather =====
    var PROJECT_COORDS = {
      'Comet Sneads Ferry Apartments': { lat: 34.58, lon: -77.40, name: 'Sneads Ferry, NC' },
      'Comet Pittsboro Apartments':    { lat: 35.72, lon: -79.18, name: 'Pittsboro, NC' },
      'Comet Richlands':               { lat: 34.90, lon: -77.55, name: 'Richlands, NC' },
      'Comet North Raleigh':           { lat: 35.87, lon: -78.63, name: 'North Raleigh, NC' },
      'Comet Lake Jeanette':           { lat: 36.13, lon: -79.85, name: 'Greensboro, NC' }
    };

    function uid(){ return Math.random().toString(36).slice(2) + Date.now().toString(36); }
    function getDrafts(){
      try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
      catch(e){ return []; }
    }
    function setDrafts(arr){ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }
    function getTemplates(){
      try{ return JSON.parse(localStorage.getItem(TEMPLATE_KEY) || '{}'); }
      catch(e){ return {}; }
    }
    function setTemplates(obj){ localStorage.setItem(TEMPLATE_KEY, JSON.stringify(obj)); }
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, function(m){
        return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m];
      });
    }

    // ===== Weather Auto-Fill =====
    function fetchWeather(){
      var project = $('#project').value;
      var dateVal = $('#date').value;

      if(!project || project === 'custom'){
        showToast('Select a project first to auto-fill weather', 'error');
        return;
      }
      var coords = PROJECT_COORDS[project];
      if(!coords){
        showToast('No coordinates mapped for this project', 'error');
        return;
      }

      var btn = $('#weatherFetchBtn');
      btn.classList.add('loading');
      btn.textContent = '‚è≥ Fetching...';

      var isToday = false;
      var target = dateVal || new Date().toISOString().split('T')[0];
      var today = new Date().toISOString().split('T')[0];
      isToday = (target === today);

      var url;
      if(isToday || !dateVal){
        // Current / today forecast
        url = 'https://api.open-meteo.com/v1/forecast?latitude='+coords.lat+'&longitude='+coords.lon+
          '&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,windspeed_10m_max,winddirection_10m_dominant,weathercode'+
          '&temperature_unit=fahrenheit&windspeed_unit=mph&precipitation_unit=inch&timezone=America%2FNew_York&forecast_days=1';
      } else {
        // Historical date
        url = 'https://api.open-meteo.com/v1/forecast?latitude='+coords.lat+'&longitude='+coords.lon+
          '&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,windspeed_10m_max,winddirection_10m_dominant,weathercode'+
          '&temperature_unit=fahrenheit&windspeed_unit=mph&precipitation_unit=inch&timezone=America%2FNew_York'+
          '&start_date='+target+'&end_date='+target;
      }

      fetch(url)
        .then(function(r){ return r.json(); })
        .then(function(data){
          if(!data.daily || !data.daily.temperature_2m_max || !data.daily.temperature_2m_max.length){
            showToast('No weather data available for that date', 'error');
            return;
          }
          var d = data.daily;
          var hi = Math.round(d.temperature_2m_max[0]);
          var lo = Math.round(d.temperature_2m_min[0]);
          var precip = d.precipitation_sum[0];
          var windMax = Math.round(d.windspeed_10m_max[0]);
          var windDir = degToCompass(d.winddirection_10m_dominant[0]);
          var code = d.weathercode[0];
          var desc = weatherCodeToText(code);

          $('#weather').value = hi + '¬∞F, ' + desc;
          $('#tempRange').value = lo + '‚Äì' + hi + '¬∞F';
          $('#precip').value = precip.toFixed(2) + ' in';
          $('#wind').value = windMax + ' mph ' + windDir;

          markUnsaved();
          showToast('Weather filled for ' + coords.name, 'success');
        })
        .catch(function(err){
          console.error(err);
          showToast('Weather fetch failed. Check connection.', 'error');
        })
        .finally(function(){
          btn.classList.remove('loading');
          btn.textContent = 'üå§Ô∏è Auto-Fill Weather';
        });
    }

    function degToCompass(deg){
      var dirs = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
      return dirs[Math.round(deg / 22.5) % 16];
    }

    function weatherCodeToText(code){
      var map = {
        0:'Clear sky',1:'Mainly clear',2:'Partly cloudy',3:'Overcast',
        45:'Foggy',48:'Depositing rime fog',
        51:'Light drizzle',53:'Moderate drizzle',55:'Dense drizzle',
        61:'Slight rain',63:'Moderate rain',65:'Heavy rain',
        71:'Slight snow',73:'Moderate snow',75:'Heavy snow',
        80:'Slight rain showers',81:'Moderate rain showers',82:'Violent rain showers',
        85:'Slight snow showers',86:'Heavy snow showers',
        95:'Thunderstorm',96:'Thunderstorm w/ slight hail',99:'Thunderstorm w/ heavy hail'
      };
      return map[code] || 'Code '+code;
    }

    // ===== Crew Templates =====
    function saveCrewTemplate(){
      var project = $('#project').value;
      if(!project || project === 'custom'){
        var cp = $('#customProject').value;
        if(!cp){ showToast('Select or name a project first', 'error'); return; }
        project = cp;
      }
      var labor = tableToJSON('#laborTable');
      if(!labor.length){
        showToast('No crew rows to save as template', 'error');
        return;
      }
      // Save only Company, Building, Supervisor, Crew count (not times/notes)
      var template = labor.map(function(row){
        return [row[0]||'', row[1]||'', row[2]||'', row[3]||''];
      }).filter(function(row){
        return row[0] || row[1] || row[2] || row[3];
      });

      if(!template.length){
        showToast('Fill in at least one crew row first', 'error');
        return;
      }

      var templates = getTemplates();
      templates[project] = { rows: template, savedAt: new Date().toISOString() };
      setTemplates(templates);
      showToast('Crew template saved for ' + project, 'success');
    }

    function loadCrewTemplate(){
      var project = $('#project').value;
      if(!project || project === 'custom'){
        var cp = $('#customProject').value;
        if(!cp){ showToast('Select or name a project first', 'error'); return; }
        project = cp;
      }
      var templates = getTemplates();
      var tmpl = templates[project];
      if(!tmpl || !tmpl.rows || !tmpl.rows.length){
        // Show available templates
        var available = Object.keys(templates);
        if(!available.length){
          showToast('No templates saved yet. Save one first.', 'error');
          return;
        }
        var choice = prompt('No template for "'+project+'". Available templates:\n\n' + available.join('\n') + '\n\nType a project name to load:');
        if(!choice) return;
        tmpl = templates[choice];
        if(!tmpl){
          showToast('Template not found for "'+choice+'"', 'error');
          return;
        }
      }

      if($('#laborTable tbody').children.length > 0){
        if(!confirm('This will replace current crew rows with the saved template. Continue?')) return;
      }

      $('#laborTable tbody').innerHTML = '';
      tmpl.rows.forEach(function(row){
        addRow($('#laborTable tbody'), [
          inputForCell(0, row[0], '#laborTable'),
          inputForCell(1, row[1], '#laborTable'),
          inputForCell(2, row[2], '#laborTable'),
          inputForCell(3, row[3], '#laborTable'),
          inputForCell(4, '', '#laborTable'),
          inputForCell(5, '', '#laborTable'),
          inputForCell(6, '', '#laborTable')
        ]);
      });
      markUnsaved();
      showToast('Crew template loaded (' + tmpl.rows.length + ' rows)', 'success');
    }

    // ===== Work Performed Auto-Summary =====
    function updateWorkSummary(){
      var labor = tableToJSON('#laborTable');
      var el = $('#workSummary');
      if(!el) return;

      // Build label lookup
      var labelMap = {};
      BUILDING_OPTIONS.forEach(function(opt){ if(opt.value) labelMap[opt.value] = opt.label; });

      var groups = {};
      var unassigned = [];

      labor.forEach(function(row){
        var company = (row[0]||'').trim();
        var building = (row[1]||'').trim();
        var crew = (row[3]||'').trim();
        var notes = (row[6]||'').trim();

        if(!company && !notes) return;

        var entry = company;
        if(crew) entry += ' (' + crew + ' crew)';
        if(notes) entry += ' ‚Äî ' + notes;

        if(building){
          var bldgLabel = labelMap[building] || building;
          if(!groups[bldgLabel]) groups[bldgLabel] = [];
          groups[bldgLabel].push(entry);
        } else {
          unassigned.push(entry);
        }
      });

      var keys = Object.keys(groups).sort();
      if(!keys.length && !unassigned.length){
        el.innerHTML = '<div class="work-summary-empty">No labor entries yet. Add crews above and this summary will populate automatically.</div>';
        return;
      }

      var html = '';
      keys.forEach(function(bldg){
        html += '<div class="building-group">';
        html += '<h3>' + escapeHtml(bldg) + '</h3>';
        groups[bldg].forEach(function(line){
          html += '<p>‚Ä¢ ' + escapeHtml(line) + '</p>';
        });
        html += '</div>';
      });

      if(unassigned.length){
        html += '<div class="building-group">';
        html += '<h3>General / Unassigned</h3>';
        unassigned.forEach(function(line){
          html += '<p>‚Ä¢ ' + escapeHtml(line) + '</p>';
        });
        html += '</div>';
      }

      el.innerHTML = html;
    }

    // ===== Dropdown Management =====
    function initDropdowns(){
      $$('.dropdown').forEach(function(dropdown){
        var toggle = dropdown.querySelector('.dropdown-toggle');
        var menu = dropdown.querySelector('.dropdown-menu');
        if(!toggle || !menu) return;
        toggle.addEventListener('click', function(e){
          e.stopPropagation();
          var isOpen = menu.classList.contains('show');
          $$('.dropdown-menu.show').forEach(function(m){ m.classList.remove('show'); });
          if(!isOpen) menu.classList.add('show');
        });
      });
      document.addEventListener('click', function(e){
        if(!e.target.closest('.dropdown')){
          $$('.dropdown-menu.show').forEach(function(m){ m.classList.remove('show'); });
        }
      });
      $$('.dropdown-menu button, .dropdown-menu label').forEach(function(item){
        item.addEventListener('click', function(){
          setTimeout(function(){ $$('.dropdown-menu.show').forEach(function(m){ m.classList.remove('show'); }); }, 100);
        });
      });
    }

    // ===== Toast =====
    function showToast(message, type){
      var existing = $('.toast');
      if(existing) existing.remove();
      var toast = document.createElement('div');
      toast.className = 'toast ' + (type || '');
      var icon = '';
      if(type === 'success') icon = '‚úì ';
      if(type === 'error') icon = '‚ö† ';
      if(type === 'warning') icon = '‚ö° ';
      toast.textContent = icon + message;
      document.body.appendChild(toast);
      setTimeout(function(){
        toast.style.animation = 'slideUp 0.3s ease reverse';
        setTimeout(function(){ toast.remove(); }, 300);
      }, 3000);
    }

    // ===== Image Compression =====
    function compressImage(file, maxWidth, quality, callback){
      var reader = new FileReader();
      reader.onload = function(e){
        var img = new Image();
        img.onload = function(){
          var canvas = document.createElement('canvas');
          var ctx = canvas.getContext('2d');
          var width = img.width, height = img.height;
          if(width > maxWidth){ height = (height * maxWidth) / width; width = maxWidth; }
          canvas.width = width; canvas.height = height;
          ctx.drawImage(img, 0, 0, width, height);
          callback(canvas.toDataURL('image/jpeg', quality));
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    // ===== Standard Building/Area List =====
    var BUILDING_OPTIONS = [
      { value: '', label: '‚Äî Select ‚Äî' },
      { value: 'C01', label: 'C01 ‚Äì Clubhouse' },
      { value: 'B01', label: 'B01' },
      { value: 'B02', label: 'B02' },
      { value: 'B03', label: 'B03' },
      { value: 'B04', label: 'B04' },
      { value: 'B05', label: 'B05' },
      { value: 'B06', label: 'B06' },
      { value: 'B07', label: 'B07' },
      { value: 'G01', label: 'G01' },
      { value: 'G02', label: 'G02' },
      { value: 'G03', label: 'G03' },
      { value: 'G04', label: 'G04' },
      { value: 'G05', label: 'G05' },
      { value: 'G06', label: 'G06' },
      { value: 'G07', label: 'G07' },
      { value: 'G08', label: 'G08' },
      { value: 'G09', label: 'G09' },
      { value: 'G10', label: 'G10' },
      { value: 'Site', label: 'Site / General' },
      { value: '__other', label: 'Other‚Ä¶' }
    ];

    function buildBuildingSelectHTML(selected){
      var html = '';
      var found = false;
      BUILDING_OPTIONS.forEach(function(opt){
        var sel = (opt.value === selected) ? ' selected' : '';
        if(opt.value === selected) found = true;
        html += '<option value="'+escapeHtml(opt.value)+'"'+sel+'>'+escapeHtml(opt.label)+'</option>';
      });
      // If the saved value is a custom one not in the list, add it
      if(selected && !found && selected !== '__other'){
        html = '<option value="'+escapeHtml(selected)+'" selected>'+escapeHtml(selected)+'</option>' + html;
      }
      return html;
    }

    function buildBuildingSelect(selected){
      // For photo tags ‚Äî same list but different empty label
      var html = '<option value="">‚Äî Tag building ‚Äî</option>';
      var found = false;
      BUILDING_OPTIONS.forEach(function(opt){
        if(opt.value === '') return; // skip blank, we added our own
        var sel = (opt.value === selected) ? ' selected' : '';
        if(opt.value === selected) found = true;
        html += '<option value="'+escapeHtml(opt.value)+'"'+sel+'>'+escapeHtml(opt.label)+'</option>';
      });
      if(selected && !found && selected !== '__other'){
        html = '<option value="'+escapeHtml(selected)+'" selected>'+escapeHtml(selected)+'</option>' + html;
      }
      return html;
    }

    // Handle "Other‚Ä¶" selection on building dropdowns
    document.addEventListener('change', function(e){
      var sel = e.target;
      if(sel.tagName !== 'SELECT') return;
      if(sel.value !== '__other') return;
      var custom = prompt('Enter custom building/area name:');
      if(custom && custom.trim()){
        custom = custom.trim();
        var opt = document.createElement('option');
        opt.value = custom; opt.textContent = custom; opt.selected = true;
        sel.insertBefore(opt, sel.querySelector('option[value="__other"]'));
      } else {
        sel.value = '';
      }
    });

    // ===== Table Helpers =====
    function inputForCell(idx, val, tableSel){
      var numberCol = (tableSel==='#laborTable' && idx===3) || (tableSel==='#equipTable' && idx===2);
      var timeCol = (tableSel==='#laborTable' && (idx===4 || idx===5)) || (tableSel==='#deliveryTable' && idx===0);
      var notesCol =
        (tableSel==='#laborTable' && idx===6) ||
        (tableSel==='#deliveryTable' && idx===4) ||
        (tableSel==='#inspTable' && idx===4) ||
        (tableSel==='#equipTable' && idx===4);

      // Building/Area dropdown for labor table
      if(tableSel==='#laborTable' && idx===1){
        return '<select>'+buildBuildingSelectHTML(val||'')+'</select>';
      }

      // Building/Area dropdown for inspection table
      if(tableSel==='#inspTable' && idx===2){
        return '<select>'+buildBuildingSelectHTML(val||'')+'</select>';
      }

      // Building/Area dropdown for delivery "For Area" column
      if(tableSel==='#deliveryTable' && idx===3){
        return '<select>'+buildBuildingSelectHTML(val||'')+'</select>';
      }

      // Inspection status dropdown
      if(tableSel==='#inspTable' && idx===3){
        var statuses = ['','Pass','Fail','Partial','Pending','Rescheduled'];
        var html = '<select>';
        statuses.forEach(function(s){
          html += '<option' + (s === val ? ' selected' : '') + '>' + s + '</option>';
        });
        html += '</select>';
        return html;
      }

      if(notesCol){
        var v = val ? escapeHtml(val) : '';
        return '<textarea class="grow" oninput="window.autoGrow(this)">'+v+'</textarea>';
      }
      if(timeCol){
        return '<input type="time" value="'+(val?escapeHtml(val):'')+'" />';
      }
      return '<input '+(numberCol? 'type="number" min="0"':'' )+' value="'+(val?escapeHtml(val):'')+'" />';
    }

    function addRow(tbody, cells){
      if(!tbody) return;
      var tr = document.createElement('tr');
      tr.innerHTML = cells.map(function(c){ return '<td>'+c+'</td>'; }).join('') +
        '<td><button class="btn small" data-remove title="Remove Row">‚úï</button></td>';
      tbody.appendChild(tr);
      setTimeout(function(){ $$('.grow', tr).forEach(function(ta){ window.autoGrow(ta); }); }, 0);
      updateKPIs();
      updateWorkSummary();
      markUnsaved();
    }

    function tableToJSON(sel){
      var rows = $$(sel+' tbody tr');
      return rows.map(function(tr){
        return Array.prototype.slice.call(tr.querySelectorAll('td')).slice(0,-1).map(function(td){
          var input = td.querySelector('input,textarea,select');
          return input ? input.value : td.textContent;
        });
      });
    }

    function jsonToTable(sel, rows){
      var tbody = $(sel+' tbody'); if(!tbody) return;
      tbody.innerHTML='';
      rows.forEach(function(r){
        addRow(tbody, r.map(function(v, idx){ return inputForCell(idx, v, sel); }));
      });
    }

    // ===== Photos with Captions & Building Tags =====
    function addPhotoToGallery(src, caption, building){
      if(!$('#gallery')) return;
      var item = document.createElement('div');
      item.className = 'photo-item';

      var imgWrap = document.createElement('div');
      imgWrap.className = 'photo-img-wrap';
      imgWrap.innerHTML = '<img src="'+src+'" alt="Site photo" />';
      imgWrap.querySelector('img').addEventListener('click', function(){ window.openImageModal(src); });

      var removeBtn = document.createElement('button');
      removeBtn.className = 'remove-photo';
      removeBtn.setAttribute('data-remove-photo', '');
      removeBtn.textContent = '‚úï';
      removeBtn.addEventListener('click', function(e){
        e.stopPropagation();
        item.style.opacity = '0.3';
        setTimeout(function(){ item.remove(); markUnsaved(); }, 150);
      });

      var meta = document.createElement('div');
      meta.className = 'photo-meta';

      var sel = document.createElement('select');
      sel.className = 'photo-building';
      sel.innerHTML = buildBuildingSelect(building || '');
      sel.addEventListener('change', function(){ markUnsaved(); });

      var cap = document.createElement('input');
      cap.className = 'photo-caption';
      cap.placeholder = 'Caption‚Ä¶';
      cap.value = caption || '';
      cap.addEventListener('input', function(){ markUnsaved(); });

      meta.appendChild(sel);
      meta.appendChild(cap);
      item.appendChild(imgWrap);
      item.appendChild(removeBtn);
      item.appendChild(meta);
      $('#gallery').appendChild(item);
    }

    // ===== Form Get/Set =====
    function getForm(){
      var labor = tableToJSON('#laborTable');
      var deliveries = tableToJSON('#deliveryTable');
      var inspections = tableToJSON('#inspTable');
      var equipment = tableToJSON('#equipTable');

      var photos = $$('#gallery .photo-item').map(function(item){
        var img = item.querySelector('img');
        var bldgSel = item.querySelector('.photo-building');
        var capInput = item.querySelector('.photo-caption');
        return {
          src: img ? img.src : '',
          building: bldgSel ? bldgSel.value : '',
          caption: capInput ? capInput.value : ''
        };
      });

      // Generate work summary text for storage
      var summaryEl = $('#workSummary');
      var workSummaryText = summaryEl ? summaryEl.innerText : '';

      return {
        id: currentId || uid(),
        date: $('#date') ? $('#date').value : '',
        project: $('#project') ? $('#project').value : '',
        customProject: $('#customProject') ? $('#customProject').value : '',
        weather: $('#weather') ? $('#weather').value : '',
        tempRange: $('#tempRange') ? $('#tempRange').value : '',
        precip: $('#precip') ? $('#precip').value : '',
        wind: $('#wind') ? $('#wind').value : '',
        workPerformed: workSummaryText,
        safetyObservations: $('#safetyObservations') ? $('#safetyObservations').value : '',
        incidents: $('#incidents') ? $('#incidents').value : '',
        delays: $('#delays') ? $('#delays').value : '',
        preparedBy: $('#preparedBy') ? $('#preparedBy').value : '',
        title: $('#titleField') ? $('#titleField').value : '',
        preparedAt: $('#preparedAt') ? $('#preparedAt').value : '',
        labor: labor,
        deliveries: deliveries,
        inspections: inspections,
        equipment: equipment,
        photos: photos,
        savedAt: new Date().toISOString()
      };
    }

    function setForm(data){
      var map = [
        ['#date','date'],['#project','project'],['#customProject','customProject'],
        ['#weather','weather'],['#tempRange','tempRange'],['#precip','precip'],['#wind','wind'],
        ['#safetyObservations','safetyObservations'],
        ['#incidents','incidents'],['#delays','delays'],['#preparedBy','preparedBy'],
        ['#titleField','title'],['#preparedAt','preparedAt']
      ];
      map.forEach(function(pair){
        var sel = pair[0], key = pair[1];
        if($(sel)) $(sel).value = data[key] || '';
      });
      jsonToTable('#laborTable', data.labor||[]);
      jsonToTable('#deliveryTable', data.deliveries||[]);
      jsonToTable('#inspTable', data.inspections||[]);
      jsonToTable('#equipTable', data.equipment||[]);

      if($('#gallery')) $('#gallery').innerHTML = '';
      var photos = data.photos || [];
      photos.forEach(function(p){
        if(typeof p === 'string'){
          // Legacy format: just a src string
          addPhotoToGallery(p, '', '');
        } else {
          addPhotoToGallery(p.src || '', p.caption || '', p.building || '');
        }
      });

      setTimeout(function(){
        $$('textarea').forEach(function(ta){ window.autoGrow(ta); });
      }, 100);

      updateKPIs();
      updateWorkSummary();
      hasUnsavedChanges = false;
      updateSaveStatus('saved');
    }

    function updateKPIs(){
      var labor = tableToJSON('#laborTable');
      var totalCrew = labor.reduce(function(sum,row){ return sum + (parseInt(row[3]||0,10)||0); }, 0);
      if($('#kpiCrew')) $('#kpiCrew').textContent = totalCrew;
      if($('#kpiVendors')) $('#kpiVendors').textContent = (function(){
        var set = {}; labor.forEach(function(r){ if(r[0]) set[r[0]] = 1; }); return Object.keys(set).length || 0;
      })();
      if($('#kpiIssues')){
        var issues = 0;
        if($('#delays') && $('#delays').value.trim()) issues++;
        if($('#incidents') && $('#incidents').value.trim() && $('#incidents').value.trim().toLowerCase() !== 'n/a') issues++;
        $('#kpiIssues').textContent = issues;
      }
      if($('#kpiInsp')) $('#kpiInsp').textContent = tableToJSON('#inspTable').length;
    }

    window.autoGrow = function(el){
      if(!el) return;
      if(!el.value || el.value.trim() === ''){ el.style.height = '42px'; return; }
      el.style.height='42px'; el.style.height=(el.scrollHeight+2)+'px';
    };

    function markUnsaved(){
      hasUnsavedChanges = true;
      updateSaveStatus('unsaved');
    }

    function updateSaveStatus(status){
      var statusEl = $('#saveStatus');
      var textEl = $('#saveText');
      if(!statusEl || !textEl) return;
      statusEl.className = 'save-status';
      if(status === 'saving'){ statusEl.classList.add('saving'); textEl.textContent = 'Saving...'; }
      else if(status === 'saved'){
        statusEl.classList.add('saved'); textEl.textContent = 'Saved ‚úì';
        setTimeout(function(){ if(statusEl.classList.contains('saved')){ statusEl.className = 'save-status'; textEl.textContent = 'Ready'; } }, 3000);
      } else if(status === 'unsaved'){ statusEl.classList.add('unsaved'); textEl.textContent = 'Unsaved Changes'; }
      else { textEl.textContent = 'Ready'; }
    }

    function saveCurrentDraft(isAutoSave){
      updateSaveStatus('saving');
      setTimeout(function(){
        var draft = getForm();
        var ds = getDrafts();
        var i = ds.findIndex(function(d){ return d.id === draft.id; });
        if(i>=0) ds[i] = draft; else ds.push(draft);
        setDrafts(ds);
        currentId = draft.id;
        hasUnsavedChanges = false;
        updateSaveStatus('saved');
        if(!isAutoSave) showToast('Report saved successfully', 'success');
        if(window.renderHistory) window.renderHistory();
      }, 200);
    }

    function loadDraft(id){
      var drafts = getDrafts();
      var d = drafts.find(function(x){ return x.id===id; });
      if(!d) return;
      currentId = id;
      setForm(d);
      window.scrollTo({top: 0, behavior: 'smooth'});
      showToast('Report loaded', 'success');
    }

    function deleteDraft(id){
      var remain = getDrafts().filter(function(x){ return x.id!==id; });
      setDrafts(remain);
      if(currentId===id) currentId=null;
      if(window.renderHistory) window.renderHistory();
      showToast('Report deleted', '');
    }

    function copyPreviousReport(){
      var drafts = getDrafts().sort(function(a,b){ return (b.date||'').localeCompare(a.date||''); });
      if(!drafts.length){ showToast('No previous reports found', 'error'); return; }
      var prev = drafts[0];
      var newReport = JSON.parse(JSON.stringify(prev));
      var today = new Date();
      newReport.id = uid();
      newReport.date = today.toISOString().split('T')[0];
      newReport.preparedAt = today.toTimeString().slice(0,5);
      newReport.safetyObservations = '';
      newReport.incidents = '';
      newReport.delays = '';
      newReport.photos = [];
      newReport.deliveries = [];
      newReport.inspections = [];
      // Clear notes from labor rows but keep company/building/supervisor/crew
      (newReport.labor||[]).forEach(function(row){
        if(row.length > 4){ row[4] = ''; row[5] = ''; }
        if(row.length > 6) row[6] = '';
      });
      currentId = newReport.id;
      setForm(newReport);
      window.scrollTo({top: 0, behavior: 'smooth'});
      showToast('Previous report copied as template', 'success');
    }

    function validateForm(){
      var errors = [];
      if(!$('#date').value) errors.push('Date is required');
      if(!$('#project').value) errors.push('Project is required');
      if($('#project').value === 'custom' && !$('#customProject').value) errors.push('Custom project name is required');
      if(!$('#preparedBy').value) errors.push('Prepared by is required');
      return errors;
    }

    window.openImageModal = function(src){
      $('#modalImg').src = src;
      $('#imageModal').classList.add('active');
      document.body.style.overflow = 'hidden';
    };
    window.closeImageModal = function(){
      $('#imageModal').classList.remove('active');
      document.body.style.overflow = '';
    };

    // ===== Global Input Listener =====
    document.addEventListener('input', function(e){
      var el = e.target;
      if(el && el.classList && el.classList.contains('grow')) window.autoGrow(el);
      if(el && el.tagName === 'TEXTAREA' && !el.classList.contains('grow')) window.autoGrow(el);
      if(el && (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.tagName === 'SELECT')){
        updateKPIs();
        updateWorkSummary();
        markUnsaved();
      }
    });

    // ===== Global Click Handler =====
    document.addEventListener('click', function(e){
      var btn = e.target.closest('button');
      var historyItem = e.target.closest('.history-item');
      var inActionsArea = e.target.closest('.actions-group');

      if(historyItem && !btn && !inActionsArea){
        e.preventDefault();
        historyItem.classList.toggle('expanded');
        return;
      }
      if(!btn) return;
      if(btn.closest('.history-item')){ e.stopPropagation(); e.preventDefault(); }

      if(btn.hasAttribute('data-remove')){
        var row = btn.closest('tr');
        if(row){
          row.style.opacity = '0.5';
          setTimeout(function(){ row.parentNode.removeChild(row); updateKPIs(); updateWorkSummary(); markUnsaved(); }, 150);
        }
        return;
      }

      switch(btn.id){
        case 'weatherFetchBtn': fetchWeather(); break;
        case 'saveTemplate': saveCrewTemplate(); break;
        case 'loadTemplate': loadCrewTemplate(); break;

        case 'saveBtn':
          var errors = validateForm();
          if(errors.length){ showToast(errors[0], 'error'); return; }
          saveCurrentDraft(false);
          break;

        case 'exportPdfBtn': case 'pdfBtn':
          var errors = validateForm();
          if(errors.length){ showToast(errors[0], 'error'); return; }
          var data = getForm();
          var projectShort = (data.customProject || data.project || 'project').replace(/[^a-z0-9]/gi,'_').substring(0, 30);
          var defaultName = 'DailyReport_'+(data.date||'undated')+'_'+projectShort;
          var filename = prompt('Enter PDF filename (without .pdf):', defaultName);
          if(filename === null) return;
          if(!filename.trim()) filename = defaultName;
          filename = filename.replace(/\.pdf$/i, '').replace(/[^a-z0-9_\-]/gi, '_');
          saveCurrentDraft(false);
          setTimeout(function(){ window.pdfFilename = filename; window.print(); }, 100);
          break;

        case 'copyPrevBtn':
          if(confirm('Copy previous report as a template? This will replace current unsaved changes.')) copyPreviousReport();
          break;

        case 'newBtn':
          if(hasUnsavedChanges && !confirm('You have unsaved changes. Continue?')) return;
          if(confirm('Start a new report? This will clear the current form.')){
            currentId = null; setForm({}); seed();
            window.scrollTo({top: 0, behavior: 'smooth'});
            showToast('New report started', '');
          }
          break;

        case 'exportBtn':
          var errors = validateForm();
          if(errors.length){ showToast(errors[0], 'error'); return; }
          var data = getForm();
          var projectShort = (data.customProject || data.project || 'project').replace(/[^a-z0-9]/gi,'_').substring(0, 30);
          var filename = 'DailyReport_'+(data.date||'undated')+'_'+projectShort+'.json';
          var blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
          var a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click();
          showToast('Report exported successfully', 'success');
          break;

        case 'printBtn':
          var errors = validateForm();
          if(errors.length){ showToast(errors[0], 'error'); return; }
          saveCurrentDraft(false);
          setTimeout(function(){ window.print(); }, 100);
          break;

        case 'addLabor':
          addRow($('#laborTable tbody'), [
            inputForCell(0,'','#laborTable'), inputForCell(1,'','#laborTable'),
            inputForCell(2,'','#laborTable'), inputForCell(3,'','#laborTable'),
            inputForCell(4,'','#laborTable'), inputForCell(5,'','#laborTable'),
            inputForCell(6,'','#laborTable')
          ]);
          break;
        case 'add5Labor':
          for(var i=0;i<5;i++) addRow($('#laborTable tbody'), [
            inputForCell(0,'','#laborTable'), inputForCell(1,'','#laborTable'),
            inputForCell(2,'','#laborTable'), inputForCell(3,'','#laborTable'),
            inputForCell(4,'','#laborTable'), inputForCell(5,'','#laborTable'),
            inputForCell(6,'','#laborTable')
          ]);
          showToast('Added 5 rows', '');
          break;
        case 'clearLabor':
          if(confirm('Clear all labor entries?')){ $('#laborTable tbody').innerHTML=''; updateKPIs(); updateWorkSummary(); markUnsaved(); showToast('Labor entries cleared', ''); }
          break;

        case 'addDelivery':
          addRow($('#deliveryTable tbody'), [
            inputForCell(0,'','#deliveryTable'), inputForCell(1,'','#deliveryTable'),
            inputForCell(2,'','#deliveryTable'), inputForCell(3,'','#deliveryTable'),
            inputForCell(4,'','#deliveryTable'), inputForCell(5,'','#deliveryTable')
          ]);
          break;
        case 'clearDelivery':
          if(confirm('Clear all deliveries?')){ $('#deliveryTable tbody').innerHTML=''; markUnsaved(); showToast('Deliveries cleared', ''); }
          break;

        case 'addInsp':
          addRow($('#inspTable tbody'), [
            inputForCell(0,'','#inspTable'), inputForCell(1,'','#inspTable'),
            inputForCell(2,'','#inspTable'), inputForCell(3,'','#inspTable'),
            inputForCell(4,'','#inspTable')
          ]);
          break;
        case 'clearInsp':
          if(confirm('Clear all inspections?')){ $('#inspTable tbody').innerHTML=''; updateKPIs(); markUnsaved(); showToast('Inspections cleared', ''); }
          break;

        case 'addEquip':
          addRow($('#equipTable tbody'), [
            inputForCell(0,'','#equipTable'), inputForCell(1,'','#equipTable'),
            inputForCell(2,'','#equipTable'), inputForCell(3,'','#equipTable'),
            inputForCell(4,'','#equipTable')
          ]);
          break;
        case 'clearEquip':
          if(confirm('Clear all equipment?')){ $('#equipTable tbody').innerHTML=''; markUnsaved(); showToast('Equipment cleared', ''); }
          break;

        case 'wipeAll':
          if(confirm('Delete ALL saved reports? This cannot be undone!')){
            localStorage.removeItem(STORAGE_KEY);
            var h = $('#history');
            if(h) h.innerHTML='<p class="muted">No drafts saved yet.</p>';
            showToast('All reports deleted', 'warning');
          }
          break;

        case 'clearPhotos':
          if(confirm('Remove all photos from this report?')){ $('#gallery').innerHTML=''; markUnsaved(); showToast('All photos removed', ''); }
          break;

        default:
          if(btn.dataset && btn.dataset.load) loadDraft(btn.dataset.load);
          if(btn.dataset && btn.dataset.del){
            if(confirm('Delete this report?')) deleteDraft(btn.dataset.del);
          }
          if(btn.dataset && btn.dataset.exportPdf){
            var draftId = btn.dataset.exportPdf;
            var drafts = getDrafts();
            var draft = drafts.find(function(d){ return d.id === draftId; });
            if(!draft){ showToast('Report not found', 'error'); return; }
            var previousId = currentId;
            var previousData = getForm();
            currentId = draft.id; setForm(draft);
            var projectShort = (draft.customProject || draft.project || 'project').replace(/[^a-z0-9]/gi,'_').substring(0, 30);
            var defaultName = 'DailyReport_'+(draft.date||'undated')+'_'+projectShort;
            var filename = prompt('Enter PDF filename (without .pdf):', defaultName);
            if(filename === null){ currentId = previousId; setForm(previousData); return; }
            if(!filename.trim()) filename = defaultName;
            filename = filename.replace(/\.pdf$/i, '').replace(/[^a-z0-9_\-]/gi, '_');
            window.pdfFilename = filename;
            setTimeout(function(){ window.print(); setTimeout(function(){ currentId = previousId; setForm(previousData); }, 500); }, 100);
          }
      }
    });

    // ===== Init =====
    document.addEventListener('DOMContentLoaded', function(){
      function seed(){
        addRow($('#laborTable tbody'), [
          inputForCell(0,'','#laborTable'), inputForCell(1,'','#laborTable'),
          inputForCell(2,'','#laborTable'), inputForCell(3,'','#laborTable'),
          inputForCell(4,'','#laborTable'), inputForCell(5,'','#laborTable'),
          inputForCell(6,'','#laborTable')
        ]);
      }
      window.seed = seed;

      function renderHistory(){
        var drafts = getDrafts().sort(function(a,b){ return (b.date||'').localeCompare(a.date||''); });
        var el = $('#history'); if(!el) return;
        if(!drafts.length){ el.innerHTML = '<p class="muted">No reports saved yet. Your reports will appear here.</p>'; return; }
        el.innerHTML = drafts.map(function(d){
          var projectName = d.customProject || d.project || 'Unnamed Project';
          var date = d.date || 'No date';
          var saved = d.savedAt ? new Date(d.savedAt).toLocaleString() : '';
          return '<div class="history-item">'+
            '<div class="info">'+
              '<div class="title">'+escapeHtml(projectName)+'</div>'+
              '<div class="meta">'+escapeHtml(date)+' ‚Ä¢ Saved: '+saved+' ‚Ä¢ Click to expand</div>'+
            '</div>'+
            '<div class="actions-group">'+
              '<button class="btn small" data-load="'+d.id+'">üìÇ Open</button>'+
              '<button class="btn small" data-export-pdf="'+d.id+'">üìÑ Export PDF</button>'+
              '<button class="btn small danger" data-del="'+d.id+'">üóëÔ∏è Delete</button>'+
            '</div>'+
          '</div>';
        }).join('');
      }
      window.renderHistory = renderHistory;

      var today = new Date();
      if($('#date')) $('#date').valueAsDate = today;
      if($('#preparedAt')) $('#preparedAt').value = today.toTimeString().slice(0,5);

      seed();
      renderHistory();
      updateKPIs();
      updateWorkSummary();
      initDropdowns();

      $$('textarea').forEach(function(ta){ window.autoGrow(ta); });

      window.addEventListener('beforeunload', function(e){
        if(hasUnsavedChanges){ e.preventDefault(); e.returnValue = ''; return ''; }
      });
      window.addEventListener('beforeprint', function(){
        saveCurrentDraft(true);
        if(window.pdfFilename) document.title = window.pdfFilename;
        else {
          var data = getForm();
          var projectShort = (data.customProject || data.project || 'project').replace(/[^a-z0-9]/gi,'_').substring(0, 30);
          document.title = 'DailyReport_'+(data.date||'undated')+'_'+projectShort;
        }
      });
      window.addEventListener('afterprint', function(){ document.title = 'Daily Reports - Comet Builders'; window.pdfFilename = null; });
      document.addEventListener('keydown', function(e){
        if((e.ctrlKey || e.metaKey) && e.key === 's'){ e.preventDefault(); saveCurrentDraft(false); }
        if((e.ctrlKey || e.metaKey) && e.key === 'p'){
          e.preventDefault();
          var errors = validateForm();
          if(!errors.length){ saveCurrentDraft(false); setTimeout(function(){ window.print(); }, 100); }
          else showToast(errors[0], 'error');
        }
      });
      window.addEventListener('online', function(){ $('#offlineBanner').classList.remove('active'); showToast('Back online', 'success'); });
      window.addEventListener('offline', function(){ $('#offlineBanner').classList.add('active'); showToast('You are offline. Changes will be saved locally.', 'warning'); });
    });

    // ===== Photo Input =====
    var photoInput = $('#photoInput');
    if(photoInput){
      photoInput.addEventListener('change', function(e){
        var files = Array.prototype.slice.call(e.target.files||[]);
        if(!files.length) return;
        showToast('Compressing '+files.length+' photo(s)...', '');
        var processed = 0;
        files.forEach(function(f){
          compressImage(f, 1400, 0.85, function(compressed){
            addPhotoToGallery(compressed, '', '');
            processed++;
            if(processed === files.length){
              showToast(files.length+' photo(s) added successfully', 'success');
              markUnsaved();
            }
          });
        });
        photoInput.value = '';
      });
    }

    // ===== Import =====
    var importFile = $('#importFile');
    if(importFile){
      importFile.addEventListener('change', function(e){
        var file = e.target.files[0]; if(!file) return;
        var reader = new FileReader();
        reader.onload = function(ev){
          try{
            var data = JSON.parse(ev.target.result);
            currentId = data.id || uid();
            setForm(data);
            window.scrollTo({top: 0, behavior: 'smooth'});
            showToast('Report imported successfully', 'success');
          } catch(err){ showToast('Error importing file: Invalid format', 'error'); }
        };
        reader.readAsText(file);
        importFile.value = '';
      });
    }

    // Prevent double-tap zoom on mobile
    var lastTouchEnd = 0;
    document.addEventListener('touchend', function(event){
      var now = Date.now();
      if(now - lastTouchEnd <= 300) event.preventDefault();
      lastTouchEnd = now;
    }, false);

  })();
  </script>
</body>
</html>
