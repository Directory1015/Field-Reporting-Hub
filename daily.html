<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0f172a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Daily Reports">
  <title>Daily Reports - Comet Builders</title>
  <meta name="description" content="Professional construction daily report system with auto-save and photo compression." />
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    :root{
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --primary-light: #dbeafe;
      --accent: #fbbf24;
      --dark: #0f172a;
      --dark-light: #1e293b;
      --bg: #f8fafc;
      --card: #ffffff;
      --border: #e2e8f0;
      --border-dark: #cbd5e1;
      --text: #0f172a;
      --text-muted: #64748b;
      --success: #10b981;
      --warn: #f59e0b;
      --danger: #ef4444;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
      --shadow-lg: 0 10px 40px rgba(0,0,0,0.12);
    }
    
    *{
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    html{
      -webkit-overflow-scrolling: touch;
      -webkit-text-size-adjust: 100%;
      scroll-behavior: smooth;
    }
    
    body{
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      -webkit-tap-highlight-color: transparent;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }
    
    a{
      color: var(--primary);
      text-decoration: none;
    }

    /* Header */
    header{
      background: linear-gradient(135deg, var(--dark) 0%, var(--dark-light) 100%);
      color: white;
      padding: 1rem;
      box-shadow: var(--shadow-lg);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-content{
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .brand{
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }
    
    .logo-container{
      width: 48px;
      height: 48px;
      flex-shrink: 0;
    }
    
    .logo-container svg{
      width: 100%;
      height: 100%;
      filter: drop-shadow(0 2px 8px rgba(0,0,0,0.3));
    }
    
    .brand-text h1{
      font-size: 1.125rem;
      font-weight: 800;
      letter-spacing: 0.5px;
      margin: 0;
      line-height: 1.2;
    }
    
    .brand-text .subtitle{
      font-size: 0.8125rem;
      opacity: 0.9;
      font-weight: 500;
      color: var(--accent);
    }
    
    /* Action Bar */
    .actions{
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    
    .save-status{
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 0.625rem 0.875rem;
      border-radius: 10px;
      font-size: 0.8125rem;
      font-weight: 600;
      background: rgba(255,255,255,0.15);
      color: white;
      transition: all 0.3s ease;
      min-height: 40px;
      border: 1px solid rgba(255,255,255,0.2);
      flex: 1 1 auto;
      min-width: 0;
    }
    
    .save-status.saving{
      background: rgba(251, 191, 36, 0.3);
      border-color: rgba(251, 191, 36, 0.5);
    }
    
    .save-status.saved{
      background: rgba(16, 185, 129, 0.3);
      border-color: rgba(16, 185, 129, 0.5);
    }
    
    .save-status.unsaved{
      background: rgba(239, 68, 68, 0.2);
      border-color: rgba(239, 68, 68, 0.4);
    }
    
    .save-status .dot{
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse{
      0%, 100%{ opacity: 1; }
      50%{ opacity: 0.5; }
    }
    
    /* Dropdown Menu */
    .dropdown{
      position: relative;
      display: inline-block;
    }
    
    .dropdown-toggle{
      min-width: auto;
      white-space: nowrap;
      padding: 0.625rem 0.875rem;
    }
    
    .dropdown-menu{
      display: none;
      position: absolute;
      top: calc(100% + 0.5rem);
      right: 0;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow-lg);
      min-width: 180px;
      z-index: 1000;
      overflow: hidden;
    }
    
    .dropdown-menu.show{
      display: block;
      animation: dropdownSlide 0.2s ease;
    }
    
    @keyframes dropdownSlide{
      from{
        opacity: 0;
        transform: translateY(-10px);
      }
      to{
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .dropdown-menu button, .dropdown-menu label{
      display: flex;
      align-items: center;
      gap: 0.75rem;
      width: 100%;
      padding: 0.875rem 1.25rem;
      background: transparent;
      color: var(--text);
      border: none;
      border-radius: 0;
      text-align: left;
      font-size: 0.9375rem;
      transition: background 0.2s ease;
      cursor: pointer;
      min-height: auto;
      font-weight: 500;
    }
    
    .dropdown-menu button:hover, .dropdown-menu label:hover{
      background: var(--bg);
      transform: none;
    }
    
    .dropdown-menu button:not(:last-child), .dropdown-menu label:not(:last-child){
      border-bottom: 1px solid var(--border);
    }
    
    .dropdown-menu .success{
      color: var(--success);
    }
    
    .dropdown-menu .success:hover{
      background: rgba(16, 185, 129, 0.05);
    }

    /* Buttons */
    button, .btn{
      appearance: none;
      -webkit-appearance: none;
      border: none;
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(10px);
      color: white;
      padding: 0.625rem 0.875rem;
      border-radius: 10px;
      font-weight: 600;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s ease;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      border: 1px solid rgba(255,255,255,0.2);
      text-decoration: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      min-height: 40px;
      user-select: none;
      -webkit-user-select: none;
    }
    
    button:hover, .btn:hover{
      background: rgba(255,255,255,0.25);
      transform: translateY(-1px);
    }
    
    button:active, .btn:active{
      transform: translateY(0);
    }
    
    .btn.primary{
      background: var(--accent);
      color: var(--dark);
      border-color: var(--accent);
    }
    
    .btn.primary:hover{
      background: #f59e0b;
    }
    
    .btn.success{
      background: rgba(16, 185, 129, 0.2);
      border-color: rgba(16, 185, 129, 0.4);
    }
    
    .btn.success:hover{
      background: rgba(16, 185, 129, 0.3);
    }
    
    .btn.warn{
      background: rgba(245, 158, 11, 0.2);
      border-color: rgba(245, 158, 11, 0.4);
    }
    
    .btn.warn:hover{
      background: rgba(245, 158, 11, 0.3);
    }
    
    .btn.small{
      padding: 0.5rem 0.875rem;
      font-size: 0.8125rem;
      min-height: 40px;
    }

    /* Container */
    .wrap{
      max-width: 1200px;
      margin: 0 auto;
      padding: 1.5rem 1rem 3rem;
    }

    /* Grid & Cards */
    .grid{
      display: grid;
      gap: 1.5rem;
    }
    
    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: var(--shadow);
      transition: box-shadow 0.3s ease;
    }
    
    .card:hover{
      box-shadow: var(--shadow-lg);
    }
    
    .card h2{
      font-size: 1.125rem;
      margin: 0 0 1.25rem 0;
      color: var(--text);
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .card h2::before{
      content: '';
      width: 4px;
      height: 1.5rem;
      background: linear-gradient(180deg, var(--primary), var(--primary-hover));
      border-radius: 2px;
    }

    /* Form Elements */
    .row{
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 1rem;
      margin-bottom: 1rem;
    }
    
    label{
      display: block;
      font-size: 0.875rem;
      color: var(--text-muted);
      font-weight: 600;
      margin-bottom: 0.5rem;
      letter-spacing: 0.01em;
    }
    
    input, select, textarea{
      width: 100%;
      padding: 0.875rem 1rem;
      border-radius: 10px;
      border: 2px solid var(--border);
      background: var(--card);
      color: var(--text);
      font-size: 1rem;
      transition: all 0.2s ease;
      font-family: inherit;
      -webkit-appearance: none;
      appearance: none;
    }
    
    input:focus, select:focus, textarea:focus{
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-light);
    }
    
    textarea{
      min-height: 100px;
      resize: vertical;
      line-height: 1.5;
      overflow: hidden;
    }

    /* Tables */
    .table-wrap{
      overflow-x: auto;
      margin-top: 1rem;
      border-radius: 12px;
      border: 1px solid var(--border);
      -webkit-overflow-scrolling: touch;
    }
    
    table{
      width: 100%;
      border-collapse: collapse;
      background: var(--card);
      min-width: 800px;
    }
    
    th, td{
      padding: 0.875rem 0.75rem;
      text-align: left;
      vertical-align: top;
      white-space: nowrap;
    }
    
    th{
      background: #f1f5f9;
      color: var(--text);
      font-weight: 700;
      font-size: 0.8125rem;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      border-bottom: 2px solid var(--border-dark);
      position: sticky;
      top: 0;
      z-index: 2;
    }
    
    td{
      border-bottom: 1px solid var(--border);
    }
    
    tr:last-child td{
      border-bottom: none;
    }
    
    tr:hover{
      background: #f8fafc;
    }
    
    td input, td textarea, td select{
      border: 1px solid var(--border);
      padding: 0.75rem 0.875rem;
      font-size: 0.9375rem;
      background: var(--card);
      min-height: 42px;
    }
    
    td input:focus, td textarea:focus, td select:focus{
      background: var(--primary-light);
      box-shadow: none;
    }
    
    td textarea.grow{
      min-height: 42px;
      min-width: 200px;
      resize: vertical;
      white-space: normal;
      line-height: 1.5;
      overflow: hidden;
    }
    
    td button[data-remove]{
      min-height: 38px;
      padding: 0.5rem 0.875rem;
      background: rgba(239, 68, 68, 0.1);
      border-color: rgba(239, 68, 68, 0.3);
      color: var(--danger);
    }
    
    td button[data-remove]:hover{
      background: rgba(239, 68, 68, 0.2);
    }

    /* Tools */
    .tools{
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
      align-items: center;
    }
    
    .muted{
      color: var(--text-muted);
      font-size: 0.8125rem;
    }

    /* Gallery */
    .gallery{
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .photo-item{
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      background: #f8fafc;
      border: 1px solid var(--border);
      aspect-ratio: 4/3;
      cursor: pointer;
    }
    
    .photo-item img{
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }
    
    .photo-item:hover img{
      transform: scale(1.05);
    }
    
    .photo-item .remove-photo{
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(239, 68, 68, 0.95);
      color: var(--card);
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s ease;
      z-index: 10;
    }
    
    .photo-item:hover .remove-photo{
      opacity: 1;
    }

    /* Modal */
    .modal{
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .modal.active{
      display: flex;
    }
    
    .modal img{
      max-width: 100%;
      max-height: 90vh;
      object-fit: contain;
      border-radius: 8px;
    }
    
    .modal-close{
      position: absolute;
      top: 20px;
      right: 20px;
      background: var(--card);
      color: var(--text);
      border: none;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* KPI Cards */
    .kpi{
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin-top: 1rem;
    }
    
    .kpi .box{
      flex: 1 1 160px;
      background: linear-gradient(135deg, #f8fafc, var(--card));
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1rem;
      box-shadow: var(--shadow);
      min-height: 90px;
    }
    
    .kpi .box label{
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .box b{
      font-size: 1.75rem;
      color: var(--primary);
      font-weight: 700;
      display: block;
    }

    /* History Items */
    .history-item{
      display: flex;
      gap: 1rem;
      align-items: center;
      margin: 0.75rem 0;
      padding: 1rem;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--card);
      transition: all 0.2s ease;
      flex-wrap: wrap;
      cursor: pointer;
      user-select: none;
    }
    
    .history-item:hover{
      box-shadow: var(--shadow);
      border-color: var(--primary-hover);
    }
    
    .history-item .info{
      flex: 1 1 200px;
    }
    
    .history-item .title{
      font-weight: 600;
      color: var(--text);
      margin-bottom: 0.25rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .history-item .title::before{
      content: '‚ñ∂';
      font-size: 0.75rem;
      color: var(--primary);
      transition: transform 0.2s ease;
    }
    
    .history-item.expanded .title::before{
      transform: rotate(90deg);
    }
    
    .history-item .meta{
      font-size: 0.75rem;
      color: var(--text-muted);
    }
    
    .history-item .actions-group{
      display: none;
      gap: 0.5rem;
      flex-wrap: wrap;
      width: 100%;
      margin-top: 0.5rem;
      padding-top: 0.75rem;
      border-top: 1px solid var(--border);
    }
    
    .history-item.expanded .actions-group{
      display: flex;
    }
    
    .history-item .btn{
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--border-dark);
    }
    
    .history-item .btn:hover{
      background: #f8fafc;
    }
    
    .history-item .btn.danger{
      color: var(--danger);
      border-color: rgba(239, 68, 68, 0.3);
    }

    /* Toast Notifications */
    .toast{
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 1rem 1.25rem;
      background: var(--dark);
      color: var(--card);
      border-radius: 12px;
      box-shadow: var(--shadow-lg);
      z-index: 3000;
      animation: slideUp 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.625rem;
      max-width: 400px;
      font-weight: 500;
      font-size: 0.875rem;
    }
    
    .toast.success{
      background: var(--success);
    }
    
    .toast.error{
      background: #dc2626;
    }
    
    .toast.warning{
      background: var(--warn);
    }
    
    @keyframes slideUp{
      from{
        transform: translateY(100px);
        opacity: 0;
      }
      to{
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* Offline Banner */
    .offline-banner{
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--warn);
      color: var(--card);
      padding: 1rem;
      text-align: center;
      font-weight: 700;
      z-index: 1500;
      font-size: 0.875rem;
    }
    
    .offline-banner.active{
      display: block;
    }

    /* Mobile Responsive */
    @media(max-width: 768px){
      header{
        padding: 0.875rem;
      }
      
      .logo-container{
        width: 42px;
        height: 42px;
      }
      
      .brand{
        gap: 0.625rem;
        margin-bottom: 0.625rem;
      }
      
      .brand-text h1{
        font-size: 1rem;
      }
      
      .brand-text .subtitle{
        font-size: 0.75rem;
      }
      
      .actions{
        gap: 0.5rem;
      }
      
      .dropdown-toggle{
        padding: 0.625rem 0.75rem;
        font-size: 0.8125rem;
      }
      
      .save-status{
        padding: 0.625rem 0.875rem;
        font-size: 0.8125rem;
      }
      
      .wrap{
        padding: 1rem 0.75rem 2rem;
      }
      
      .card{
        padding: 1.25rem;
        border-radius: 12px;
      }
      
      .row{
        grid-template-columns: 1fr;
        gap: 0.875rem;
      }
      
      .row > div{
        grid-column: span 1 !important;
      }
      
      .table-wrap{
        border-radius: 10px;
        margin-left: -0.75rem;
        margin-right: -0.75rem;
        border-left: none;
        border-right: none;
      }
      
      table{
        min-width: 1000px;
        font-size: 0.9375rem;
      }
      
      th, td{
        padding: 0.75rem 0.625rem;
        font-size: 0.875rem;
      }
      
      td input, td textarea, td select{
        font-size: 1rem;
        padding: 0.75rem 0.875rem;
      }
      
      td textarea.grow{
        min-width: 280px;
      }
      
      .gallery{
        grid-template-columns: repeat(2, 1fr);
        gap: 0.875rem;
      }
      
      .kpi{
        gap: 0.875rem;
      }
      
      .kpi .box{
        padding: 0.875rem;
        flex: 1 1 140px;
        min-height: 85px;
      }
      
      .box b{
        font-size: 1.625rem;
      }
      
      .toast{
        bottom: 1rem;
        right: 1rem;
        left: 1rem;
        max-width: none;
      }
      
      .history-item{
        padding: 0.875rem;
      }
      
      .history-item .title{
        font-size: 0.9375rem;
      }
      
      .history-item .actions-group{
        width: 100%;
        gap: 0.5rem;
      }
      
      .history-item .btn{
        flex: 1 1 auto;
        min-width: 0;
      }
    }

    @media(max-width: 480px){
      .btn{
        font-size: 0.8125rem;
        padding: 0.625rem 0.75rem;
      }
    }

    /* Print Styles */
    @media print{
      @page{
        size: letter;
        margin: 0.5in;
      }
      
      header, .actions, .tools, .btn, .save-status, .offline-banner, .modal, .dropdown{
        display: none !important;
      }
      
      body{
        background: var(--card) !important;
        color: #000 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
        padding: 0 !important;
      }
      
      .wrap{
        padding: 0;
        max-width: 100%;
      }
      
      .card{
        break-inside: avoid;
        background: var(--card) !important;
        border: 1px solid #000 !important;
        box-shadow: none !important;
        page-break-inside: avoid;
        margin-bottom: 1rem;
        padding: 1rem !important;
      }
      
      .card h2{
        page-break-after: avoid;
        font-size: 0.875rem !important;
      }
      
      input, select, textarea{
        background: var(--card) !important;
        color: #000 !important;
        border: 1px solid #000 !important;
        -webkit-text-fill-color: #000 !important;
        font-size: 0.6875rem !important;
        padding: 0.25rem 0.375rem !important;
      }
      
      textarea{
        min-height: auto !important;
        height: auto !important;
        overflow: visible !important;
      }
      
      .table-wrap{
        overflow: visible !important;
        border: none !important;
        margin: 0 !important;
      }
      
      table{
        width: 100% !important;
        min-width: 0 !important;
        font-size: 0.625rem !important;
        page-break-inside: auto;
      }
      
      thead{
        display: table-header-group;
      }
      
      tbody{
        display: table-row-group;
      }
      
      tr{
        page-break-inside: avoid;
        page-break-after: auto;
      }
      
      th, td{
        border: 1px solid #000 !important;
        color: #000 !important;
        padding: 0.25rem !important;
        font-size: 0.625rem !important;
        white-space: normal !important;
        word-wrap: break-word;
      }
      
      th{
        background: #f0f0f0 !important;
        color: #000 !important;
        font-weight: bold !important;
      }
      
      td input, td textarea, td select{
        font-size: 0.625rem !important;
        padding: 0.125rem 0.25rem !important;
        width: 100%;
      }
      
      td textarea.grow{
        min-width: 0 !important;
        width: 100% !important;
      }
      
      td button{
        display: none !important;
      }
      
      .kpi{
        display: flex !important;
        gap: 0.5rem;
        page-break-inside: avoid;
      }
      
      .kpi .box{
        background: var(--card) !important;
        color: #000 !important;
        border: 2px solid #000 !important;
        flex: 1;
        padding: 0.5rem !important;
      }
      
      .kpi .box label, .kpi .box b{
        color: #000 !important;
        font-size: 0.6875rem !important;
      }
      
      .kpi .box b{
        font-size: 1rem !important;
      }
      
      .gallery{
        grid-template-columns: repeat(4, 1fr) !important;
        gap: 0.5rem;
        page-break-inside: avoid;
      }
      
      .photo-item{
        break-inside: avoid;
      }
      
      .photo-item .remove-photo{
        display: none !important;
      }
      
      .photo-item img{
        max-height: 120px;
      }
      
      .row{
        grid-template-columns: repeat(12, 1fr) !important;
        gap: 0.5rem !important;
        page-break-inside: avoid;
      }
      
      label{
        font-size: 0.625rem !important;
        margin-bottom: 0.125rem !important;
      }
    }
  </style>
</head>
<body>

  <!-- Version Check & Cache Clear -->
  <script>
    (function(){
      var APP_VERSION = '2025-11-21-COMPACT-v1';
      try {
        var stored = localStorage.getItem('app_version');
        if (stored !== APP_VERSION) {
          if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(regs){
              regs.forEach(function(r){ r.unregister(); });
              if (window.caches && caches.keys) {
                caches.keys().then(function(keys){
                  keys.forEach(function(k){ caches.delete(k); });
                  localStorage.setItem('app_version', APP_VERSION);
                  location.reload();
                });
              } else {
                localStorage.setItem('app_version', APP_VERSION);
                location.reload();
              }
            });
          } else {
            localStorage.setItem('app_version', APP_VERSION);
          }
        }
      } catch (e) {}
    })();
  </script>

  <!-- Offline Indicator -->
  <div class="offline-banner" id="offlineBanner">
    üì° You're offline. Changes are saved locally and will sync when reconnected.
  </div>

  <!-- Image Modal -->
  <div class="modal" id="imageModal" onclick="if(event.target.id==='imageModal')closeImageModal()">
    <button class="modal-close" onclick="closeImageModal()">√ó</button>
    <img id="modalImg" src="" alt="Preview">
  </div>

  <header>
    <div class="header-content">
      <div class="brand">
        <div class="logo-container">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
            <defs>
              <linearGradient id="professionalBg" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" style="stop-color:#1e3a8a;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#0f172a;stop-opacity:1" />
              </linearGradient>
              <linearGradient id="brickGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" style="stop-color:#7c3aed;stop-opacity:0.3" />
                <stop offset="100%" style="stop-color:#6366f1;stop-opacity:0.5" />
              </linearGradient>
              <linearGradient id="sidingGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" style="stop-color:#60a5fa;stop-opacity:0.6" />
                <stop offset="100%" style="stop-color:#3b82f6;stop-opacity:0.7" />
              </linearGradient>
              <linearGradient id="roofGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" style="stop-color:#94a3b8;stop-opacity:0.8" />
                <stop offset="100%" style="stop-color:#64748b;stop-opacity:0.9" />
              </linearGradient>
              <linearGradient id="cometGold" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#fde047;stop-opacity:1" />
                <stop offset="50%" style="stop-color:#fbbf24;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#f59e0b;stop-opacity:1" />
              </linearGradient>
            </defs>
            <rect width="512" height="512" rx="110" fill="url(#professionalBg)"/>
            <path d="M 80 90 L 380 155" stroke="url(#cometGold)" stroke-width="5" fill="none" opacity="0.7" stroke-linecap="round"/>
            <path d="M 90 95 L 375 157" stroke="#fde047" stroke-width="2.5" fill="none" opacity="0.9" stroke-linecap="round"/>
            <circle cx="390" cy="160" r="20" fill="url(#cometGold)"/>
            <circle cx="390" cy="160" r="12" fill="#fde047"/>
            <path d="M 390 160 l 9 5 l 5 9 l -5 -9 l -9 5 l 5 -9 l 9 -5 l -5 9 z" fill="#ffffff" opacity="0.9"/>
            <circle cx="256" cy="280" r="140" fill="#0f172a" stroke="url(#cometGold)" stroke-width="6"/>
            <circle cx="256" cy="280" r="130" fill="#1e293b"/>
            <rect x="130" y="310" width="55" height="50" fill="url(#brickGrad)"/>
            <rect x="135" y="318" width="10" height="12" fill="#dbeafe" opacity="0.9"/>
            <rect x="148" y="318" width="10" height="12" fill="#dbeafe" opacity="0.9"/>
            <rect x="161" y="318" width="10" height="12" fill="#dbeafe" opacity="0.9"/>
            <rect x="135" y="345" width="10" height="12" fill="#dbeafe" opacity="0.9"/>
            <rect x="161" y="345" width="10" height="12" fill="#dbeafe" opacity="0.9"/>
            <rect x="148" y="345" width="10" height="15" fill="#1e3a8a" opacity="0.8"/>
            <rect x="130" y="295" width="55" height="15" fill="url(#sidingGrad)"/>
            <rect x="135" y="298" width="10" height="10" fill="#dbeafe" opacity="0.9"/>
            <rect x="148" y="298" width="10" height="10" fill="#dbeafe" opacity="0.9"/>
            <rect x="161" y="298" width="10" height="10" fill="#dbeafe" opacity="0.9"/>
            <path d="M 127 295 L 157.5 270 L 188 295 Z" fill="url(#roofGrad)"/>
            <rect x="195" y="300" width="65" height="60" fill="url(#brickGrad)"/>
            <rect x="200" y="308" width="11" height="14" fill="#dbeafe"/>
            <rect x="215" y="308" width="11" height="14" fill="#dbeafe"/>
            <rect x="230" y="308" width="11" height="14" fill="#dbeafe"/>
            <rect x="245" y="308" width="11" height="14" fill="#dbeafe"/>
            <rect x="200" y="340" width="11" height="18" fill="#1e3a8a" opacity="0.8"/>
            <rect x="230" y="340" width="11" height="18" fill="#1e3a8a" opacity="0.8"/>
            <rect x="195" y="285" width="65" height="15" fill="url(#sidingGrad)"/>
            <rect x="200" y="288" width="11" height="10" fill="#dbeafe"/>
            <rect x="215" y="288" width="11" height="10" fill="#dbeafe"/>
            <rect x="230" y="288" width="11" height="10" fill="#dbeafe"/>
            <rect x="245" y="288" width="11" height="10" fill="#dbeafe"/>
            <rect x="195" y="270" width="65" height="15" fill="url(#brickGrad)"/>
            <rect x="215" y="273" width="11" height="9" fill="#dbeafe"/>
            <rect x="230" y="273" width="11" height="9" fill="#dbeafe"/>
            <path d="M 193 270 L 227.5 240 L 262 270 Z" fill="url(#roofGrad)"/>
            <rect x="245" y="343" width="12" height="15" fill="#475569" opacity="0.7"/>
            <line x1="245" y1="347" x2="257" y2="347" stroke="#94a3b8" stroke-width="0.5"/>
            <line x1="245" y1="350" x2="257" y2="350" stroke="#94a3b8" stroke-width="0.5"/>
            <line x1="245" y1="353" x2="257" y2="353" stroke="#94a3b8" stroke-width="0.5"/>
            <rect x="270" y="305" width="58" height="55" fill="url(#sidingGrad)"/>
            <rect x="275" y="313" width="10" height="13" fill="#dbeafe" opacity="0.9"/>
            <rect x="289" y="313" width="10" height="13" fill="#dbeafe" opacity="0.9"/>
            <rect x="303" y="313" width="10" height="13" fill="#dbeafe" opacity="0.9"/>
            <rect x="317" y="313" width="10" height="13" fill="#dbeafe" opacity="0.9"/>
            <rect x="275" y="343" width="10" height="16" fill="#1e3a8a" opacity="0.8"/>
            <rect x="303" y="343" width="10" height="16" fill="#1e3a8a" opacity="0.8"/>
            <rect x="270" y="290" width="58" height="15" fill="url(#brickGrad)"/>
            <rect x="275" y="293" width="10" height="10" fill="#dbeafe" opacity="0.9"/>
            <rect x="289" y="293" width="10" height="10" fill="#dbeafe" opacity="0.9"/>
            <rect x="303" y="293" width="10" height="10" fill="#dbeafe" opacity="0.9"/>
            <rect x="317" y="293" width="10" height="10" fill="#dbeafe" opacity="0.9"/>
            <path d="M 267 290 L 299 265 L 331 290 Z" fill="url(#roofGrad)"/>
            <rect x="335" y="312" width="45" height="48" fill="url(#brickGrad)"/>
            <rect x="340" y="320" width="9" height="12" fill="#dbeafe" opacity="0.9"/>
            <rect x="352" y="320" width="9" height="12" fill="#dbeafe" opacity="0.9"/>
            <rect x="364" y="320" width="9" height="12" fill="#dbeafe" opacity="0.9"/>
            <rect x="340" y="345" width="9" height="14" fill="#1e3a8a" opacity="0.8"/>
            <rect x="364" y="345" width="9" height="14" fill="#1e3a8a" opacity="0.8"/>
            <rect x="335" y="300" width="45" height="12" fill="url(#sidingGrad)"/>
            <rect x="340" y="303" width="9" height="8" fill="#dbeafe" opacity="0.9"/>
            <rect x="352" y="303" width="9" height="8" fill="#dbeafe" opacity="0.9"/>
            <rect x="364" y="303" width="9" height="8" fill="#dbeafe" opacity="0.9"/>
            <path d="M 332 300 L 357.5 278 L 383 300 Z" fill="url(#roofGrad)"/>
            <ellipse cx="256" cy="370" rx="125" ry="15" fill="#2D5016" opacity="0.4"/>
            <ellipse cx="125" cy="365" rx="8" ry="10" fill="#2D5016" opacity="0.6"/>
            <ellipse cx="385" cy="368" rx="8" ry="10" fill="#2D5016" opacity="0.6"/>
            <text x="256" y="450" font-family="Arial, sans-serif" font-size="46" font-weight="900" text-anchor="middle" fill="#ffffff" letter-spacing="10">COMET</text>
            <text x="256" y="485" font-family="Arial, sans-serif" font-size="28" font-weight="600" text-anchor="middle" fill="#60a5fa" letter-spacing="8">BUILDERS</text>
          </svg>
        </div>
        <div class="brand-text">
          <h1>Comet Builders LLC</h1>
          <div class="subtitle">Daily Reports</div>
        </div>
      </div>
      <div class="actions">
        <a href="index.html" class="btn">üè†</a>
        <div class="save-status" id="saveStatus">
          <span class="dot"></span>
          <span id="saveText">Ready</span>
        </div>
        
        <!-- Actions Dropdown -->
        <div class="dropdown" id="actionsDropdown">
          <button class="btn dropdown-toggle" id="actionsToggle">‚ö° Actions</button>
          <div class="dropdown-menu" id="actionsMenu">
            <button id="saveBtn" class="success">üíæ Save Report</button>
            <button id="copyPrevBtn">üìã Copy Yesterday</button>
            <button id="newBtn">üÜï New Report</button>
            <button id="exportBtn">üíæ Export JSON</button>
            <button id="exportPdfBtn">üìÑ Export PDF</button>
            <label for="importFile">üì• Import JSON</label>
            <input type="file" id="importFile" accept="application/json" hidden>
            <button id="printBtn" class="success">üñ®Ô∏è Print</button>
            <button id="pdfBtn" class="success">üìÑ Save PDF</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="wrap">
    <section class="grid">
      <!-- Report Meta -->
      <div class="card">
        <h2>Report Information</h2>
        <div class="row">
          <div style="grid-column:span 3">
            <label for="date">Date *</label>
            <input type="date" id="date" required>
          </div>
          <div style="grid-column:span 5">
            <label for="project">Project *</label>
            <select id="project" required>
              <option value="">Select project‚Ä¶</option>
              <option>Comet Sneads Ferry Apartments</option>
              <option>Comet Pittsboro Apartments</option>
              <option>Comet Richlands</option>
              <option>Comet North Raleigh</option>
              <option>Comet Lake Jeanette</option>
              <option value="custom">Custom‚Ä¶</option>
            </select>
          </div>
          <div style="grid-column:span 4">
            <label for="customProject">Custom Project Name</label>
            <input id="customProject" placeholder="Enter if Custom selected" />
          </div>
        </div>
        <div class="row">
          <div style="grid-column:span 3">
            <label for="weather">Weather Summary</label>
            <input id="weather" placeholder="78¬∞F, partly cloudy" />
          </div>
          <div style="grid-column:span 3">
            <label for="tempRange">Temperature Range</label>
            <input id="tempRange" placeholder="65‚Äì82¬∞F" />
          </div>
          <div style="grid-column:span 3">
            <label for="precip">Precipitation</label>
            <input id="precip" placeholder="0.0 in" />
          </div>
          <div style="grid-column:span 3">
            <label for="wind">Wind</label>
            <input id="wind" placeholder="5 mph SW" />
          </div>
        </div>
        <div class="kpi">
          <div class="box"><label>Total Crew</label><div><b id="kpiCrew">0</b></div></div>
          <div class="box"><label>Vendors On-Site</label><div><b id="kpiVendors">0</b></div></div>
          <div class="box"><label>Open Issues</label><div><b id="kpiIssues">0</b></div></div>
          <div class="box"><label>Inspections</label><div><b id="kpiInsp">0</b></div></div>
        </div>
      </div>

      <!-- Manpower & Vendors -->
      <div class="card">
        <h2>Manpower & Vendors</h2>
        <div class="tools">
          <button class="btn small" id="addLabor">‚ûï Add Row</button>
          <button class="btn small" id="add5Labor">‚ûï 5 Rows</button>
          <button class="btn small" id="clearLabor">üóëÔ∏è Clear</button>
          <span class="muted">Track all subcontractors and crews on site</span>
        </div>
        <div class="table-wrap">
          <table id="laborTable">
            <thead>
              <tr>
                <th>Company / Trade</th>
                <th>Building/Area</th>
                <th>Supervisor</th>
                <th># Crew</th>
                <th>Time On</th>
                <th>Time Off</th>
                <th>Notes</th>
                <th style="width:60px">‚Äî</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Work Performed -->
      <div class="card">
        <h2>Work Performed Today</h2>
        <div class="row">
          <div style="grid-column:span 12">
            <label for="workPerformed">Summary by Area/Trade</label>
            <textarea id="workPerformed" placeholder="Example: Bldg 1 ‚Äì Framing 2nd floor east wing; Bldg 2 ‚Äì MEP rough-ins in units 201-210; Site ‚Äì Installed irrigation mainline south of Bldg 3"></textarea>
          </div>
        </div>
      </div>

      <!-- Deliveries -->
      <div class="card">
        <h2>Material Deliveries</h2>
        <div class="tools">
          <button class="btn small" id="addDelivery">‚ûï Add Delivery</button>
          <button class="btn small" id="clearDelivery">üóëÔ∏è Clear</button>
        </div>
        <div class="table-wrap">
          <table id="deliveryTable">
            <thead>
              <tr>
                <th>Time</th>
                <th>Vendor</th>
                <th>Material / Qty</th>
                <th>For Area</th>
                <th>Notes</th>
                <th>Received By</th>
                <th style="width:60px">‚Äî</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Inspections & Tests -->
      <div class="card">
        <h2>Inspections & Testing</h2>
        <div class="tools">
          <button class="btn small" id="addInsp">‚ûï Add Item</button>
          <button class="btn small" id="clearInsp">üóëÔ∏è Clear</button>
        </div>
        <div class="table-wrap">
          <table id="inspTable">
            <thead>
              <tr>
                <th>Agency / Inspector</th>
                <th>Type</th>
                <th>Building/Area</th>
                <th>Status</th>
                <th>Notes</th>
                <th style="width:60px">‚Äî</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Equipment On Site -->
      <div class="card">
        <h2>Equipment On-Site</h2>
        <div class="tools">
          <button class="btn small" id="addEquip">‚ûï Add Equipment</button>
          <button class="btn small" id="clearEquip">üóëÔ∏è Clear</button>
          <span class="muted">Track all equipment to prevent loss/damage</span>
        </div>
        <div class="table-wrap">
          <table id="equipTable">
            <thead>
              <tr>
                <th>Type/Model</th>
                <th>Owner/Subcontractor</th>
                <th>Qty</th>
                <th>Location</th>
                <th>Condition/Notes</th>
                <th style="width:60px">‚Äî</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Safety / Incidents -->
      <div class="card">
        <h2>Safety & Incidents</h2>
        <div class="row">
          <div style="grid-column:span 6">
            <label for="safetyObservations">Safety Observations / Toolbox Talks</label>
            <textarea id="safetyObservations" placeholder="PPE compliance checks, toolbox talk topics, safety concerns addressed, near-miss events"></textarea>
          </div>
          <div style="grid-column:span 6">
            <label for="incidents">Incidents / Accidents</label>
            <textarea id="incidents" placeholder="Document any incidents, injuries, or property damage. Write 'N/A' if none occurred."></textarea>
          </div>
        </div>
      </div>

      <!-- Delays / Constraints -->
      <div class="card">
        <h2>Delays, Constraints & Issues</h2>
        <div class="row">
          <div style="grid-column:span 12">
            <label for="delays">Today's Delays / Constraints / RFI Needs</label>
            <textarea id="delays" placeholder="Pending inspections, utility conflicts, weather delays, material shortages, approvals needed, change order items, etc."></textarea>
          </div>
        </div>
      </div>

      <!-- Photos -->
      <div class="card">
        <h2>Site Photos</h2>
        <div class="tools">
          <label class="btn small" for="photoInput">üì∑ Add Photos</label>
          <input type="file" id="photoInput" accept="image/*" multiple capture="environment" hidden>
          <button class="btn small" id="clearPhotos">üóëÔ∏è Clear All</button>
          <span class="muted">Photos are compressed and stored locally</span>
        </div>
        <div class="gallery" id="gallery"></div>
      </div>

      <!-- Sign-off -->
      <div class="card">
        <h2>Report Sign-Off</h2>
        <div class="row">
          <div style="grid-column:span 4">
            <label for="preparedBy">Prepared By *</label>
            <input id="preparedBy" placeholder="Your full name" required />
          </div>
          <div style="grid-column:span 4">
            <label for="title">Title</label>
            <input id="title" placeholder="Superintendent" />
          </div>
          <div style="grid-column:span 4">
            <label for="preparedAt">Time Prepared</label>
            <input id="preparedAt" type="time" />
          </div>
        </div>
      </div>

      <!-- History -->
      <div class="card">
        <h2>Saved Reports</h2>
        <div class="tools">
          <button class="btn warn small" id="wipeAll">üóëÔ∏è Delete All Drafts</button>
          <span class="muted">Click any report to expand and see actions. Export JSON for backup.</span>
        </div>
        <div id="history"></div>
      </div>
    </section>
  </div>

  <!-- Main Application Logic -->
  <script>
  (function(){
    'use strict';
    
    // Utility Functions
    function $(s, r){ return (r||document).querySelector(s); }
    function $$(s, r){ return Array.prototype.slice.call((r||document).querySelectorAll(s)); }
    
    var STORAGE_KEY = 'dailyReportDrafts_v4_upgraded';
    var currentId = null;
    var autoSaveTimer = null;
    var hasUnsavedChanges = false;

    function uid(){ return Math.random().toString(36).slice(2) + Date.now().toString(36); }
    function getDrafts(){ 
      try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
      catch(e){ return []; } 
    }
    function setDrafts(arr){ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }
    function escapeHtml(s){ 
      return String(s).replace(/[&<>"']/g, function(m){ 
        return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]; 
      }); 
    }

    // Dropdown Management
    function initDropdowns(){
      var dropdowns = $$('.dropdown');
      
      dropdowns.forEach(function(dropdown){
        var toggle = dropdown.querySelector('.dropdown-toggle');
        var menu = dropdown.querySelector('.dropdown-menu');
        
        if(!toggle || !menu) return;
        
        toggle.addEventListener('click', function(e){
          e.stopPropagation();
          var isOpen = menu.classList.contains('show');
          
          // Close all other dropdowns
          $$('.dropdown-menu.show').forEach(function(m){ m.classList.remove('show'); });
          
          if(!isOpen){
            menu.classList.add('show');
          }
        });
      });
      
      // Close dropdowns when clicking outside
      document.addEventListener('click', function(e){
        if(!e.target.closest('.dropdown')){
          $$('.dropdown-menu.show').forEach(function(m){ m.classList.remove('show'); });
        }
      });
      
      // Close dropdown when clicking a menu item
      $$('.dropdown-menu button, .dropdown-menu label').forEach(function(item){
        item.addEventListener('click', function(){
          setTimeout(function(){
            $$('.dropdown-menu.show').forEach(function(m){ m.classList.remove('show'); });
          }, 100);
        });
      });
    }

    // Toast Notification System
    function showToast(message, type){
      var existing = $('.toast');
      if(existing) existing.remove();
      
      var toast = document.createElement('div');
      toast.className = 'toast ' + (type || '');
      
      var icon = '';
      if(type === 'success') icon = '‚úì ';
      if(type === 'error') icon = '‚ö† ';
      if(type === 'warning') icon = '‚ö° ';
      
      toast.textContent = icon + message;
      document.body.appendChild(toast);
      
      setTimeout(function(){ 
        toast.style.animation = 'slideUp 0.3s ease reverse';
        setTimeout(function(){ toast.remove(); }, 300);
      }, 3000);
    }

    // Image Compression
    function compressImage(file, maxWidth, quality, callback){
      var reader = new FileReader();
      reader.onload = function(e){
        var img = new Image();
        img.onload = function(){
          var canvas = document.createElement('canvas');
          var ctx = canvas.getContext('2d');
          
          var width = img.width;
          var height = img.height;
          
          if(width > maxWidth){
            height = (height * maxWidth) / width;
            width = maxWidth;
          }
          
          canvas.width = width;
          canvas.height = height;
          ctx.drawImage(img, 0, 0, width, height);
          
          callback(canvas.toDataURL('image/jpeg', quality));
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    // Table Input Helper
    function inputForCell(idx, val, tableSel){
      var numberCol = (tableSel==='#laborTable' && idx===3) || (tableSel==='#equipTable' && idx===2);
      var timeCol = (tableSel==='#laborTable' && (idx===4 || idx===5)) || (tableSel==='#deliveryTable' && idx===0);
      var notesCol =
        (tableSel==='#laborTable' && idx===6) ||
        (tableSel==='#deliveryTable' && idx===4) ||
        (tableSel==='#inspTable' && idx===4) ||
        (tableSel==='#equipTable' && idx===4);
      
      if (notesCol) {
        var v = val ? escapeHtml(val) : '';
        return '<textarea class="grow" oninput="window.autoGrow(this)">'+v+'</textarea>';
      }
      
      if(timeCol){
        return '<input type="time" value="'+(val?escapeHtml(val):'')+'" />';
      }
      
      return '<input '+(numberCol? 'type="number" min="0"':'' )+' value="'+(val?escapeHtml(val):'')+'" />';
    }

    function addRow(tbody, cells){
      if(!tbody) return;
      var tr = document.createElement('tr');
      tr.innerHTML = cells.map(function(c){ return '<td>'+c+'</td>'; }).join('') + 
        '<td><button class="btn small" data-remove title="Remove Row">‚úï</button></td>';
      tbody.appendChild(tr);
      
      setTimeout(function(){
        $$('.grow', tr).forEach(function(ta){ window.autoGrow(ta); });
      }, 0);
      
      updateKPIs();
      markUnsaved();
    }

    function tableToJSON(sel){
      var rows = $$(sel+' tbody tr');
      return rows.map(function(tr){
        return Array.prototype.slice.call(tr.querySelectorAll('td')).slice(0,-1).map(function(td){
          var input = td.querySelector('input,textarea,select');
          return input ? input.value : td.textContent;
        });
      });
    }
    
    function jsonToTable(sel, rows){
      var tbody = $(sel+' tbody'); if(!tbody) return;
      tbody.innerHTML='';
      rows.forEach(function(r){
        addRow(tbody, r.map(function(v, idx){ return inputForCell(idx, v, sel); }));
      });
    }

    function getForm(){
      var labor = tableToJSON('#laborTable');
      var deliveries = tableToJSON('#deliveryTable');
      var inspections = tableToJSON('#inspTable');
      var equipment = tableToJSON('#equipTable');
      var photos = $$('#gallery .photo-item img').map(function(img){ return img.src; });
      
      return {
        id: currentId || uid(),
        date: $('#date') ? $('#date').value : '',
        project: $('#project') ? $('#project').value : '',
        customProject: $('#customProject') ? $('#customProject').value : '',
        weather: $('#weather') ? $('#weather').value : '',
        tempRange: $('#tempRange') ? $('#tempRange').value : '',
        precip: $('#precip') ? $('#precip').value : '',
        wind: $('#wind') ? $('#wind').value : '',
        workPerformed: $('#workPerformed') ? $('#workPerformed').value : '',
        safetyObservations: $('#safetyObservations') ? $('#safetyObservations').value : '',
        incidents: $('#incidents') ? $('#incidents').value : '',
        delays: $('#delays') ? $('#delays').value : '',
        preparedBy: $('#preparedBy') ? $('#preparedBy').value : '',
        title: $('#title') ? $('#title').value : '',
        preparedAt: $('#preparedAt') ? $('#preparedAt').value : '',
        labor: labor, 
        deliveries: deliveries, 
        inspections: inspections, 
        equipment: equipment, 
        photos: photos,
        savedAt: new Date().toISOString()
      };
    }

    function setForm(data){
      var map = [
        ['#date','date'],['#project','project'],['#customProject','customProject'],
        ['#weather','weather'],['#tempRange','tempRange'],['#precip','precip'],['#wind','wind'],
        ['#workPerformed','workPerformed'],['#safetyObservations','safetyObservations'],
        ['#incidents','incidents'],['#delays','delays'],['#preparedBy','preparedBy'],
        ['#title','title'],['#preparedAt','preparedAt']
      ];
      map.forEach(function(pair){
        var sel = pair[0], key = pair[1];
        if($(sel)) $(sel).value = data[key] || '';
      });
      jsonToTable('#laborTable', data.labor||[]);
      jsonToTable('#deliveryTable', data.deliveries||[]);
      jsonToTable('#inspTable', data.inspections||[]);
      jsonToTable('#equipTable', data.equipment||[]);
      if($('#gallery')) $('#gallery').innerHTML = '';
      (data.photos||[]).forEach(function(src){ addPhotoToGallery(src); });
      
      setTimeout(function(){
        $$('textarea').forEach(function(ta){ window.autoGrow(ta); });
      }, 100);
      
      updateKPIs();
      hasUnsavedChanges = false;
      updateSaveStatus('saved');
    }

    function addPhotoToGallery(src){
      if(!$('#gallery')) return;
      var item = document.createElement('div');
      item.className = 'photo-item';
      item.innerHTML = '<img src="'+src+'" alt="Site photo" onclick="window.openImageModal(\''+src+'\')" />' +
        '<button class="remove-photo" data-remove-photo onclick="event.stopPropagation()">‚úï</button>';
      $('#gallery').appendChild(item);
    }

    function updateKPIs(){
      var labor = tableToJSON('#laborTable');
      var totalCrew = labor.reduce(function(sum,row){ 
        return sum + (parseInt(row[3]||0,10)||0); 
      }, 0);
      if($('#kpiCrew')) $('#kpiCrew').textContent = totalCrew;
      
      if($('#kpiVendors')) $('#kpiVendors').textContent = (function(){
        var set = {}; 
        labor.forEach(function(r){ if(r[0]) set[r[0]] = 1; }); 
        return Object.keys(set).length || 0;
      })();
      
      if($('#kpiIssues')){
        var issues = 0;
        if($('#delays') && $('#delays').value.trim()) issues++;
        if($('#incidents') && $('#incidents').value.trim() && $('#incidents').value.trim().toLowerCase() !== 'n/a') issues++;
        $('#kpiIssues').textContent = issues;
      }
      
      if($('#kpiInsp')) $('#kpiInsp').textContent = tableToJSON('#inspTable').length;
    }

    window.autoGrow = function(el){ 
      if (!el) return;
      if(!el.value || el.value.trim() === ''){
        el.style.height = '42px';
        return;
      }
      el.style.height='42px'; 
      el.style.height=(el.scrollHeight+2)+'px'; 
    };

    function markUnsaved(){
      hasUnsavedChanges = true;
      updateSaveStatus('unsaved');
      // Auto-save disabled - user must manually save
    }

    function updateSaveStatus(status){
      var statusEl = $('#saveStatus');
      var textEl = $('#saveText');
      if(!statusEl || !textEl) return;
      
      statusEl.className = 'save-status';
      
      if(status === 'saving'){
        statusEl.classList.add('saving');
        textEl.textContent = 'Saving...';
      } else if(status === 'saved'){
        statusEl.classList.add('saved');
        textEl.textContent = 'Saved ‚úì';
        setTimeout(function(){
          if(statusEl.classList.contains('saved')){
            statusEl.className = 'save-status';
            textEl.textContent = 'Ready';
          }
        }, 3000);
      } else if(status === 'unsaved'){
        statusEl.classList.add('unsaved');
        textEl.textContent = 'Unsaved Changes';
      } else {
        textEl.textContent = 'Ready';
      }
    }

    function scheduleAutoSave(){
      if(autoSaveTimer) clearTimeout(autoSaveTimer);
      autoSaveTimer = setTimeout(function(){
        saveCurrentDraft(true);
      }, 2000);
    }

    function saveCurrentDraft(isAutoSave){
      updateSaveStatus('saving');
      
      setTimeout(function(){
        var draft = getForm();
        var ds = getDrafts();
        var i = ds.findIndex(function(d){ return d.id === draft.id; });
        if(i>=0) ds[i] = draft; else ds.push(draft);
        setDrafts(ds); 
        currentId = draft.id;
        hasUnsavedChanges = false;
        updateSaveStatus('saved');
        
        if(!isAutoSave){
          showToast('Report saved successfully', 'success');
        }
        
        if(window.renderHistory) window.renderHistory();
      }, 200);
    }

    function loadDraft(id){
      var drafts = getDrafts();
      var d = drafts.find(function(x){ return x.id===id; });
      if(!d) return;
      currentId = id;
      setForm(d);
      window.scrollTo({top: 0, behavior: 'smooth'});
      showToast('Report loaded', 'success');
    }
    
    function deleteDraft(id){
      var remain = getDrafts().filter(function(x){ return x.id!==id; });
      setDrafts(remain);
      if(currentId===id){ currentId=null; }
      if (window.renderHistory) window.renderHistory();
      showToast('Report deleted', '');
    }

    function copyPreviousReport(){
      var drafts = getDrafts().sort(function(a,b){ 
        return (b.date||'').localeCompare(a.date||''); 
      });
      
      if(!drafts.length){
        showToast('No previous reports found', 'error');
        return;
      }
      
      var prev = drafts[0];
      var newReport = JSON.parse(JSON.stringify(prev));
      
      var today = new Date();
      newReport.id = uid();
      newReport.date = today.toISOString().split('T')[0];
      newReport.preparedAt = today.toTimeString().slice(0,5);
      newReport.workPerformed = '';
      newReport.safetyObservations = '';
      newReport.incidents = '';
      newReport.delays = '';
      newReport.photos = [];
      newReport.deliveries = [];
      newReport.inspections = [];
      
      currentId = newReport.id;
      setForm(newReport);
      window.scrollTo({top: 0, behavior: 'smooth'});
      showToast('Previous report copied as template', 'success');
    }

    function validateForm(){
      var errors = [];
      
      if(!$('#date').value) errors.push('Date is required');
      if(!$('#project').value) errors.push('Project is required');
      if($('#project').value === 'custom' && !$('#customProject').value){
        errors.push('Custom project name is required');
      }
      if(!$('#preparedBy').value) errors.push('Prepared by is required');
      
      return errors;
    }

    window.openImageModal = function(src){
      $('#modalImg').src = src;
      $('#imageModal').classList.add('active');
      document.body.style.overflow = 'hidden';
    };

    window.closeImageModal = function(){
      $('#imageModal').classList.remove('active');
      document.body.style.overflow = '';
    };

    document.addEventListener('input', function(e){
      var el = e.target;
      if (el && el.classList && el.classList.contains('grow')) window.autoGrow(el);
      if (el && el.tagName === 'TEXTAREA' && !el.classList.contains('grow')) {
        window.autoGrow(el);
      }
      if (el && (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.tagName === 'SELECT')) {
        updateKPIs();
        markUnsaved();
      }
    });

    document.addEventListener('click', function(e){
      var btn = e.target.closest ? e.target.closest('button') : null;
      
      // Handle history item expansion
      var historyItem = e.target.closest('.history-item');
      if(historyItem && !btn){
        historyItem.classList.toggle('expanded');
        return;
      }
      
      if (!btn) return;

      if (btn.hasAttribute('data-remove')) {
        var row = btn.closest && btn.closest('tr'); 
        if(row) {
          row.style.opacity = '0.5';
          setTimeout(function(){
            row.parentNode.removeChild(row);
            updateKPIs(); 
            markUnsaved();
          }, 150);
        }
        return;
      }

      if(btn.hasAttribute('data-remove-photo')){
        var item = btn.closest('.photo-item');
        if(item) {
          item.style.opacity = '0.3';
          setTimeout(function(){
            item.remove();
            markUnsaved();
          }, 150);
        }
        return;
      }

      switch (btn.id) {
        case 'saveBtn':
          var errors = validateForm();
          if(errors.length){
            showToast(errors[0], 'error');
            return;
          }
          saveCurrentDraft(false);
          break;

        case 'exportPdfBtn':
          var errors = validateForm();
          if(errors.length){
            showToast(errors[0], 'error');
            return;
          }
          var data = getForm();
          var projectShort = (data.customProject || data.project || 'project').replace(/[^a-z0-9]/gi,'_').substring(0, 30);
          var defaultName = 'DailyReport_'+(data.date||'undated')+'_'+projectShort;
          
          var filename = prompt('Enter PDF filename (without .pdf):', defaultName);
          if(filename === null) return;
          
          if(!filename.trim()){
            filename = defaultName;
          }
          
          filename = filename.replace(/\.pdf$/i, '');
          filename = filename.replace(/[^a-z0-9_\-]/gi, '_');
          
          saveCurrentDraft(false);
          setTimeout(function(){ 
            window.pdfFilename = filename;
            window.print(); 
          }, 100);
          break;

        case 'copyPrevBtn':
          if(confirm('Copy previous report as a template? This will replace current unsaved changes.')){
            copyPreviousReport();
          }
          break;

        case 'newBtn':
          if (hasUnsavedChanges && !confirm('You have unsaved changes. Continue?')) return;
          if (confirm('Start a new report? This will clear the current form.')) { 
            currentId = null; 
            setForm({}); 
            seed(); 
            window.scrollTo({top: 0, behavior: 'smooth'});
            showToast('New report started', '');
          }
          break;

        case 'exportBtn':
          var errors = validateForm();
          if(errors.length){
            showToast(errors[0], 'error');
            return;
          }
          var data = getForm();
          var projectShort = (data.customProject || data.project || 'project').replace(/[^a-z0-9]/gi,'_').substring(0, 30);
          var filename = 'DailyReport_'+(data.date||'undated')+'_'+projectShort+'.json';
          
          var blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
          var a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = filename;
          a.click();
          showToast('Report exported successfully', 'success');
          break;

        case 'pdfBtn':
          var errors = validateForm();
          if(errors.length){
            showToast(errors[0], 'error');
            return;
          }
          var data = getForm();
          var projectShort = (data.customProject || data.project || 'project').replace(/[^a-z0-9]/gi,'_').substring(0, 30);
          var defaultName = 'DailyReport_'+(data.date||'undated')+'_'+projectShort;
          
          var filename = prompt('Enter filename for PDF (without .pdf):', defaultName);
          if(filename === null) return; // User cancelled
          
          if(!filename.trim()){
            filename = defaultName;
          }
          
          // Remove .pdf if user added it
          filename = filename.replace(/\.pdf$/i, '');
          
          // Clean filename - remove special characters
          filename = filename.replace(/[^a-z0-9_\-]/gi, '_');
          
          saveCurrentDraft(false);
          setTimeout(function(){ 
            window.pdfFilename = filename;
            window.print(); 
          }, 100);
          break;

        case 'printBtn':
          var errors = validateForm();
          if(errors.length){
            showToast(errors[0], 'error');
            return;
          }
          saveCurrentDraft(false);
          setTimeout(function(){ window.print(); }, 100);
          break;

        case 'addLabor':
          addRow($('#laborTable tbody'), [
            inputForCell(0,'' ,'#laborTable'),
            inputForCell(1,'' ,'#laborTable'),
            inputForCell(2,'' ,'#laborTable'),
            inputForCell(3,'' ,'#laborTable'),
            inputForCell(4,'' ,'#laborTable'),
            inputForCell(5,'' ,'#laborTable'),
            inputForCell(6,'' ,'#laborTable')
          ]);
          break;

        case 'add5Labor':
          for(var i=0; i<5; i++){
            addRow($('#laborTable tbody'), [
              inputForCell(0,'' ,'#laborTable'),
              inputForCell(1,'' ,'#laborTable'),
              inputForCell(2,'' ,'#laborTable'),
              inputForCell(3,'' ,'#laborTable'),
              inputForCell(4,'' ,'#laborTable'),
              inputForCell(5,'' ,'#laborTable'),
              inputForCell(6,'' ,'#laborTable')
            ]);
          }
          showToast('Added 5 rows', '');
          break;

        case 'clearLabor':
          if(confirm('Clear all labor entries?')) { 
            $('#laborTable tbody').innerHTML=''; 
            updateKPIs(); 
            markUnsaved();
            showToast('Labor entries cleared', '');
          }
          break;

        case 'addDelivery':
          addRow($('#deliveryTable tbody'), [
            inputForCell(0,'' ,'#deliveryTable'),
            inputForCell(1,'' ,'#deliveryTable'),
            inputForCell(2,'' ,'#deliveryTable'),
            inputForCell(3,'' ,'#deliveryTable'),
            inputForCell(4,'' ,'#deliveryTable'),
            inputForCell(5,'' ,'#deliveryTable')
          ]);
          break;

        case 'clearDelivery':
          if(confirm('Clear all deliveries?')) { 
            $('#deliveryTable tbody').innerHTML=''; 
            markUnsaved();
            showToast('Deliveries cleared', '');
          }
          break;

        case 'addInsp':
          addRow($('#inspTable tbody'), [
            inputForCell(0,'' ,'#inspTable'),
            inputForCell(1,'' ,'#inspTable'),
            inputForCell(2,'' ,'#inspTable'),
            inputForCell(3,'' ,'#inspTable'),
            inputForCell(4,'' ,'#inspTable')
          ]);
          break;

        case 'clearInsp':
          if(confirm('Clear all inspections?')) { 
            $('#inspTable tbody').innerHTML=''; 
            updateKPIs();
            markUnsaved();
            showToast('Inspections cleared', '');
          }
          break;

        case 'addEquip':
          addRow($('#equipTable tbody'), [
            inputForCell(0,'' ,'#equipTable'),
            inputForCell(1,'' ,'#equipTable'),
            inputForCell(2,'' ,'#equipTable'),
            inputForCell(3,'' ,'#equipTable'),
            inputForCell(4,'' ,'#equipTable')
          ]);
          break;

        case 'clearEquip':
          if(confirm('Clear all equipment?')) { 
            $('#equipTable tbody').innerHTML=''; 
            markUnsaved();
            showToast('Equipment cleared', '');
          }
          break;

        case 'wipeAll':
          if(confirm('Delete ALL saved reports? This cannot be undone!')) { 
            localStorage.removeItem(STORAGE_KEY); 
            var h = $('#history'); 
            if(h) h.innerHTML='<p class="muted">No drafts saved yet.</p>';
            showToast('All reports deleted', 'warning');
          }
          break;

        default:
          if (btn.dataset && btn.dataset.load) loadDraft(btn.dataset.load);
          if (btn.dataset && btn.dataset.del) { 
            if (confirm('Delete this report?')) deleteDraft(btn.dataset.del); 
          }
          if (btn.dataset && btn.dataset.exportPdf) {
            var draftId = btn.dataset.exportPdf;
            var drafts = getDrafts();
            var draft = drafts.find(function(d){ return d.id === draftId; });
            if(!draft) {
              showToast('Report not found', 'error');
              return;
            }
            
            // Temporarily load the draft
            var previousId = currentId;
            var previousData = getForm();
            
            currentId = draft.id;
            setForm(draft);
            
            // Generate PDF
            var projectShort = (draft.customProject || draft.project || 'project').replace(/[^a-z0-9]/gi,'_').substring(0, 30);
            var defaultName = 'DailyReport_'+(draft.date||'undated')+'_'+projectShort;
            
            var filename = prompt('Enter PDF filename (without .pdf):', defaultName);
            if(filename === null) {
              // Restore previous state if cancelled
              currentId = previousId;
              setForm(previousData);
              return;
            }
            
            if(!filename.trim()){
              filename = defaultName;
            }
            
            filename = filename.replace(/\.pdf$/i, '');
            filename = filename.replace(/[^a-z0-9_\-]/gi, '_');
            
            window.pdfFilename = filename;
            
            setTimeout(function(){
              window.print();
              // Restore previous state after print dialog
              setTimeout(function(){
                currentId = previousId;
                setForm(previousData);
              }, 500);
            }, 100);
          }
      }
    });

    document.addEventListener('DOMContentLoaded', function(){
      function seed(){
        addRow($('#laborTable tbody'), [
          inputForCell(0,'' ,'#laborTable'),
          inputForCell(1,'' ,'#laborTable'),
          inputForCell(2,'' ,'#laborTable'),
          inputForCell(3,'' ,'#laborTable'),
          inputForCell(4,'' ,'#laborTable'),
          inputForCell(5,'' ,'#laborTable'),
          inputForCell(6,'' ,'#laborTable')
        ]);
      }
      window.seed = seed;

      function renderHistory(){
        var drafts = getDrafts().sort(function(a,b){ 
          return (b.date||'').localeCompare(a.date||''); 
        });
        var el = $('#history'); 
        if(!el) return;
        
        if(!drafts.length){ 
          el.innerHTML = '<p class="muted">No reports saved yet. Your reports will appear here.</p>'; 
          return; 
        }
        
        el.innerHTML = drafts.map(function(d){
          var projectName = d.customProject || d.project || 'Unnamed Project';
          var date = d.date || 'No date';
          var saved = d.savedAt ? new Date(d.savedAt).toLocaleString() : '';
          
          return '<div class="history-item">'+
            '<div class="info">'+
              '<div class="title">'+escapeHtml(projectName)+'</div>'+
              '<div class="meta">'+escapeHtml(date)+' ‚Ä¢ Saved: '+saved+' ‚Ä¢ Click to expand</div>'+
            '</div>'+
            '<div class="actions-group">'+
              '<button class="btn small" data-load="'+d.id+'" onclick="event.stopPropagation()">üìÇ Open</button>'+
              '<button class="btn small" data-export-pdf="'+d.id+'" onclick="event.stopPropagation()">üìÑ Export PDF</button>'+
              '<button class="btn small danger" data-del="'+d.id+'" onclick="event.stopPropagation()">üóëÔ∏è Delete</button>'+
            '</div>'+
          '</div>';
        }).join('');
      }
      window.renderHistory = renderHistory;

      var today = new Date();
      if($('#date')) $('#date').valueAsDate = today;
      if($('#preparedAt')) $('#preparedAt').value = today.toTimeString().slice(0,5);
      
      seed();
      renderHistory();
      updateKPIs();
      initDropdowns();
      
      $$('textarea').forEach(function(ta){ window.autoGrow(ta); });
      
      window.addEventListener('beforeunload', function(e){
        if(hasUnsavedChanges){
          e.preventDefault();
          e.returnValue = '';
          return '';
        }
      });

      window.addEventListener('beforeprint', function(){
        // Auto-save before printing/PDF (this is intentional)
        saveCurrentDraft(true);
        // Change document title to the filename for PDF save/share
        if(window.pdfFilename){
          // Use the custom filename set by user
          document.title = window.pdfFilename;
        } else {
          // Fallback to auto-generated name
          var data = getForm();
          var projectShort = (data.customProject || data.project || 'project').replace(/[^a-z0-9]/gi,'_').substring(0, 30);
          document.title = 'DailyReport_'+(data.date||'undated')+'_'+projectShort;
        }
      });

      window.addEventListener('afterprint', function(){
        document.title = 'Daily Reports - Comet Builders';
        window.pdfFilename = null;
      });

      document.addEventListener('keydown', function(e){
        if((e.ctrlKey || e.metaKey) && e.key === 's'){
          e.preventDefault();
          saveCurrentDraft(false);
        }
        if((e.ctrlKey || e.metaKey) && e.key === 'p'){
          e.preventDefault();
          var errors = validateForm();
          if(!errors.length){
            saveCurrentDraft(false);
            setTimeout(function(){ window.print(); }, 100);
          } else {
            showToast(errors[0], 'error');
          }
        }
      });

      window.addEventListener('online', function(){
        $('#offlineBanner').classList.remove('active');
        showToast('Back online', 'success');
      });
      
      window.addEventListener('offline', function(){
        $('#offlineBanner').classList.add('active');
        showToast('You are offline. Changes will be saved locally.', 'warning');
      });
    });

    var photoInput = $('#photoInput');
    if(photoInput){
      photoInput.addEventListener('change', function(e){
        var files = Array.prototype.slice.call(e.target.files||[]);
        if(!files.length) return;
        
        showToast('Compressing '+files.length+' photo(s)...', '');
        
        var processed = 0;
        files.forEach(function(f){
          compressImage(f, 1400, 0.85, function(compressed){
            addPhotoToGallery(compressed);
            processed++;
            if(processed === files.length){
              showToast(files.length+' photo(s) added successfully', 'success');
              markUnsaved();
            }
          });
        });
        photoInput.value = '';
      });
    }

    var clearPhotosBtn = $('#clearPhotos');
    if(clearPhotosBtn){
      clearPhotosBtn.addEventListener('click', function(){ 
        if(confirm('Remove all photos from this report?')) {
          $('#gallery').innerHTML=''; 
          markUnsaved();
          showToast('All photos removed', '');
        }
      });
    }

    var importFile = $('#importFile');
    if(importFile){
      importFile.addEventListener('change', function(e){
        var file = e.target.files[0];
        if(!file) return;
        
        var reader = new FileReader();
        reader.onload = function(ev){
          try{
            var data = JSON.parse(ev.target.result);
            currentId = data.id || uid();
            setForm(data);
            window.scrollTo({top: 0, behavior: 'smooth'});
            showToast('Report imported successfully', 'success');
          } catch(err){
            showToast('Error importing file: Invalid format', 'error');
          }
        };
        reader.readAsText(file);
        importFile.value = '';
      });
    }

    var lastTouchEnd = 0;
    document.addEventListener('touchend', function(event) {
      var now = Date.now();
      if (now - lastTouchEnd <= 300) {
        event.preventDefault();
      }
      lastTouchEnd = now;
    }, false);

  })();
  </script>
</body>
</html>
